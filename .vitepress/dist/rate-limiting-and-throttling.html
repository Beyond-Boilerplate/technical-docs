<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Technical RFC: Rate Limiting &amp; Throttling Solution Based on Bucket4J and Redis | VitePress</title>
    <meta name="description" content="A VitePress site">
    <meta name="generator" content="VitePress v1.4.1">
    <link rel="preload stylesheet" href="/assets/style.DTi47vbO.css" as="style">
    
    <script type="module" src="/assets/app.B7H0UzUQ.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.1L8kWkwp.js">
    <link rel="modulepreload" href="/assets/chunks/framework.BGo0cstt.js">
    <link rel="modulepreload" href="/assets/rate-limiting-and-throttling.md.C1EVT8kM.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-d8b57b2d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-d8b57b2d data-v-7ad780c2><div class="VPNavBar" data-v-7ad780c2 data-v-9fd4d1dd><div class="wrapper" data-v-9fd4d1dd><div class="container" data-v-9fd4d1dd><div class="title" data-v-9fd4d1dd><div class="VPNavBarTitle" data-v-9fd4d1dd data-v-0ad69264><a class="title" href="/" data-v-0ad69264><!--[--><!--]--><!----><span data-v-0ad69264>VitePress</span><!--[--><!--]--></a></div></div><div class="content" data-v-9fd4d1dd><div class="content-body" data-v-9fd4d1dd><!--[--><!--]--><div class="VPNavBarSearch search" data-v-9fd4d1dd><!----></div><!----><!----><div class="VPNavBarAppearance appearance" data-v-9fd4d1dd data-v-3f90c1a5><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-3f90c1a5 data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-9fd4d1dd data-v-f953d92f data-v-bfe7971f><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-bfe7971f><span class="vpi-more-horizontal icon" data-v-bfe7971f></span></button><div class="menu" data-v-bfe7971f><div class="VPMenu" data-v-bfe7971f data-v-20ed86d6><!----><!--[--><!--[--><!----><div class="group" data-v-f953d92f><div class="item appearance" data-v-f953d92f><p class="label" data-v-f953d92f>Appearance</p><div class="appearance-action" data-v-f953d92f><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-f953d92f data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-9fd4d1dd data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-9fd4d1dd><div class="divider-line" data-v-9fd4d1dd></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-d8b57b2d data-v-2488c25a><div class="container" data-v-2488c25a><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-2488c25a data-v-883964e0><button data-v-883964e0>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-d8b57b2d data-v-9a6c75ad><div class="VPDoc has-aside" data-v-9a6c75ad data-v-e6f2a212><!--[--><!--]--><div class="container" data-v-e6f2a212><div class="aside" data-v-e6f2a212><div class="aside-curtain" data-v-e6f2a212></div><div class="aside-container" data-v-e6f2a212><div class="aside-content" data-v-e6f2a212><div class="VPDocAside" data-v-e6f2a212 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-cb998dce data-v-f610f197><div class="content" data-v-f610f197><div class="outline-marker" data-v-f610f197></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-f610f197>On this page</div><ul class="VPDocOutlineItem root" data-v-f610f197 data-v-53c99d69><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e6f2a212><div class="content-container" data-v-e6f2a212><!--[--><!--]--><main class="main" data-v-e6f2a212><div style="position:relative;" class="vp-doc _rate-limiting-and-throttling" data-v-e6f2a212><div><h1 id="technical-rfc-rate-limiting-throttling-solution-based-on-bucket4j-and-redis" tabindex="-1">Technical RFC: Rate Limiting &amp; Throttling Solution Based on Bucket4J and Redis <a class="header-anchor" href="#technical-rfc-rate-limiting-throttling-solution-based-on-bucket4j-and-redis" aria-label="Permalink to &quot;Technical RFC: Rate Limiting &amp; Throttling Solution Based on Bucket4J and Redis&quot;">​</a></h1><hr><h3 id="objective" tabindex="-1">Objective <a class="header-anchor" href="#objective" aria-label="Permalink to &quot;Objective&quot;">​</a></h3><p>To provide a robust, scalable, and production-ready rate limiting and throttling solution that can dynamically limit requests based on client IP, API key, or user. The RFC will outline both a naive implementation and a more sophisticated production-ready solution using the <strong>Bucket4J</strong> library and <strong>Redis</strong> for distributed token management. It will also discuss theoretical foundations, implementation steps, and how to scale the solution beyond IP-based limitations.</p><hr><h2 id="problem-statement" tabindex="-1">Problem Statement <a class="header-anchor" href="#problem-statement" aria-label="Permalink to &quot;Problem Statement&quot;">​</a></h2><p>Web services must control the rate at which clients can make requests to ensure system stability and prevent abuse. Without rate limiting, systems are vulnerable to performance degradation, security risks (DDoS attacks), and resource exhaustion.</p><hr><h2 id="theoretical-foundations-rate-limiting-and-token-buckets" tabindex="-1">Theoretical Foundations: Rate Limiting and Token Buckets <a class="header-anchor" href="#theoretical-foundations-rate-limiting-and-token-buckets" aria-label="Permalink to &quot;Theoretical Foundations: Rate Limiting and Token Buckets&quot;">​</a></h2><h3 id="rate-limiting" tabindex="-1"><strong>Rate Limiting</strong>: <a class="header-anchor" href="#rate-limiting" aria-label="Permalink to &quot;**Rate Limiting**:&quot;">​</a></h3><p>Rate limiting restricts the number of requests a user, IP, or API key can make within a specific time window. The most common algorithms for rate limiting include:</p><ol><li><strong>Fixed Window Counter</strong>: Allows a fixed number of requests in a time window (e.g., 100 requests in 1 minute).</li><li><strong>Sliding Window Log</strong>: Tracks individual requests and allows a fixed number of requests in a time window with more granular control.</li><li><strong>Token Bucket Algorithm</strong>: Allows bursts of traffic, refilling a set number of tokens into a bucket at a regular interval. Requests consume tokens, and once the bucket is empty, the requests are rate-limited.</li></ol><h3 id="token-bucket-theory" tabindex="-1"><strong>Token Bucket Theory</strong>: <a class="header-anchor" href="#token-bucket-theory" aria-label="Permalink to &quot;**Token Bucket Theory**:&quot;">​</a></h3><ul><li><strong>Bucket Size</strong>: Defines the maximum number of tokens that the bucket can hold.</li><li><strong>Token Refill Rate</strong>: Defines how many tokens are added to the bucket per unit of time (e.g., 20 tokens per minute).</li><li><strong>Request Consumption</strong>: Each request consumes a token. If the bucket is empty, the request is denied until tokens are refilled.</li><li><strong>Bursty Traffic</strong>: The token bucket allows traffic bursts because tokens can accumulate when not used.</li></ul><p>Example:</p><ul><li><strong>Bucket size</strong>: 50 tokens.</li><li><strong>Refill rate</strong>: 20 tokens per minute.</li><li>A user can send up to 50 requests instantly (if the bucket is full), and 20 additional requests after every minute.</li></ul><hr><h2 id="naive-solution-in-memory-rate-limiting" tabindex="-1">Naive Solution: In-Memory Rate Limiting <a class="header-anchor" href="#naive-solution-in-memory-rate-limiting" aria-label="Permalink to &quot;Naive Solution: In-Memory Rate Limiting&quot;">​</a></h2><h3 id="naive-implementation" tabindex="-1"><strong>Naive Implementation</strong>: <a class="header-anchor" href="#naive-implementation" aria-label="Permalink to &quot;**Naive Implementation**:&quot;">​</a></h3><p>A simple solution would store the request count for each client (based on IP address) in an in-memory map (<code>ConcurrentHashMap</code>). Each request increments the counter, and once the limit is reached, further requests are denied until a fixed time window elapses.</p><h3 id="code-example" tabindex="-1"><strong>Code Example</strong>: <a class="header-anchor" href="#code-example" aria-label="Permalink to &quot;**Code Example**:&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.concurrent.ConcurrentHashMap;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.concurrent.TimeUnit;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> NaiveRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ConcurrentHashMap&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; requestCounts </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ConcurrentHashMap&lt;&gt;();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MAX_REQUESTS </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TIME_WINDOW </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TimeUnit.MINUTES.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toMillis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> boolean</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">clientIp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentTimeMillis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        requestCounts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">putIfAbsent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(clientIp, currentTime);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastRequestTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> requestCounts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(clientIp);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (currentTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastRequestTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TIME_WINDOW) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            requestCounts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">put</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(clientIp, currentTime);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// reset window</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> requestCounts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(clientIp) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MAX_REQUESTS;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="naive-solution-drawbacks" tabindex="-1"><strong>Naive Solution Drawbacks</strong>: <a class="header-anchor" href="#naive-solution-drawbacks" aria-label="Permalink to &quot;**Naive Solution Drawbacks**:&quot;">​</a></h3><ul><li><strong>Memory Limitations</strong>: In-memory storage is limited to a single instance, and data is lost if the instance restarts.</li><li><strong>No Scalability</strong>: Cannot scale across multiple servers or instances (not suited for distributed systems).</li><li><strong>No Granularity</strong>: Lacks flexibility in terms of API key or user-based limiting.</li><li><strong>Vulnerable to Bursts</strong>: Does not handle burst traffic effectively.</li></ul><hr><h2 id="production-ready-solution-using-bucket4j-and-redis" tabindex="-1">Production-Ready Solution: Using Bucket4J and Redis <a class="header-anchor" href="#production-ready-solution-using-bucket4j-and-redis" aria-label="Permalink to &quot;Production-Ready Solution: Using Bucket4J and Redis&quot;">​</a></h2><h3 id="bucket4j-redis" tabindex="-1"><strong>Bucket4J + Redis</strong>: <a class="header-anchor" href="#bucket4j-redis" aria-label="Permalink to &quot;**Bucket4J + Redis**:&quot;">​</a></h3><p><strong>Bucket4J</strong> is a library that provides a token-bucket-based rate limiting implementation, and when integrated with <strong>Redis</strong>, it supports distributed rate limiting across multiple instances of an application.</p><h3 id="how-bucket4j-redis-works" tabindex="-1"><strong>How Bucket4J + Redis Works</strong>: <a class="header-anchor" href="#how-bucket4j-redis-works" aria-label="Permalink to &quot;**How Bucket4J + Redis Works**:&quot;">​</a></h3><ol><li><strong>Bucket Configuration</strong>: Define the bucket size and refill rate dynamically based on the API endpoint, HTTP method, or client attribute (IP, API key, or user).</li><li><strong>Token Consumption</strong>: Each request consumes one token from the bucket.</li><li><strong>Redis Integration</strong>: Redis stores the bucket state (remaining tokens, refill time), allowing multiple instances to share the same rate limit configuration.</li><li><strong>Scalability</strong>: Distributed systems can share rate-limiting states, ensuring consistency across instances.</li><li><strong>Flexibility</strong>: Rate limits can be set for different levels—IP-based, API key-based, or user-based.</li></ol><h3 id="code-example-1" tabindex="-1"><strong>Code Example</strong>: <a class="header-anchor" href="#code-example-1" aria-label="Permalink to &quot;**Code Example**:&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.github.bucket4j.Bucket;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.github.bucket4j.BucketConfiguration;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.github.bucket4j.Bandwidth;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.github.bucket4j.distributed.proxy.ProxyManager;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.github.bucket4j.redis.lettuce.cas.LettuceBasedProxyManager;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.lettuce.core.RedisClient;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.lettuce.core.RedisURI;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.lettuce.core.api.StatefulRedisConnection;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.lettuce.core.codec.StringCodec;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.core.env.Environment;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.time.Duration;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.function.Supplier;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Bucket4JRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ProxyManager&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; proxyManager;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Bucket4JRateLimiter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Environment </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">environment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        RedisClient redisClient </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RedisClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(RedisURI.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">builder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">withHost</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;localhost&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">withPort</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6379</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        StatefulRedisConnection&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[]&gt; redisConnection </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> redisClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">connect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(StringCodec.UTF8, StringCodec.BYTE);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.proxyManager </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LettuceBasedProxyManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">builderFor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(redisConnection).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Supplier&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BucketConfiguration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bucketConfiguration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">endpoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">method</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BucketConfiguration.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">builder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addLimit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Bandwidth.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">simple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Duration.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ofSeconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">60</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> boolean</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">clientIp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">endpoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">method</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Bucket bucket </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> proxyManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">builder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(clientIp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> endpoint </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> method, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bucketConfiguration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(endpoint, method));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bucket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tryConsume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="expanding-beyond-ip-based-limiting" tabindex="-1">Expanding Beyond IP-Based Limiting <a class="header-anchor" href="#expanding-beyond-ip-based-limiting" aria-label="Permalink to &quot;Expanding Beyond IP-Based Limiting&quot;">​</a></h2><p>While the above solutions are IP-based, we can expand the system to work with <strong>API keys</strong> or <strong>users</strong>. This would involve:</p><ul><li><strong>Identifying the Client</strong>: Using the <strong>API key</strong> or <strong>user ID</strong> passed in the request header or parameters.</li><li><strong>Generating the Key</strong>: Instead of using <code>clientIp</code>, generate the Redis key based on the API key or user ID, i.e., <code>&quot;rate_limit:&quot; + apiKey + &quot;:&quot; + endpoint + &quot;:&quot; + httpMethod</code> or <code>&quot;rate_limit:&quot; + userId + &quot;:&quot; + endpoint + &quot;:&quot; + httpMethod</code>.</li><li><strong>Flexible Configurations</strong>: Different limits can be applied based on the type of user or API key (e.g., free-tier vs. premium users).</li></ul><h3 id="code-example-for-api-key-based-limiting" tabindex="-1"><strong>Code Example for API-Key-Based Limiting</strong>: <a class="header-anchor" href="#code-example-for-api-key-based-limiting" aria-label="Permalink to &quot;**Code Example for API-Key-Based Limiting**:&quot;">​</a></h3><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> boolean</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> isAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String apiKey, String endpoint, String method) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    String key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;rate_limit:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> apiKey </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> endpoint </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;:&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> method;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Bucket bucket </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> proxyManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">builder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bucketConfiguration</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(endpoint, method));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bucket.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tryConsume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="decision-matrix-comparing-naive-vs-bucket4j-based-solutions" tabindex="-1">Decision Matrix: Comparing Naive vs. Bucket4J-based Solutions <a class="header-anchor" href="#decision-matrix-comparing-naive-vs-bucket4j-based-solutions" aria-label="Permalink to &quot;Decision Matrix: Comparing Naive vs. Bucket4J-based Solutions&quot;">​</a></h2><table tabindex="0"><thead><tr><th><strong>Aspect</strong></th><th><strong>Naive (In-Memory)</strong></th><th><strong>Bucket4J + Redis</strong></th></tr></thead><tbody><tr><td><strong>Scalability</strong></td><td>Limited to single instance</td><td>Distributed and scalable across instances</td></tr><tr><td><strong>State Management</strong></td><td>In-memory, lost on restart</td><td>Persistent in Redis</td></tr><tr><td><strong>Handling Bursts</strong></td><td>Limited, not effective</td><td>Handles burst traffic naturally</td></tr><tr><td><strong>Granularity</strong></td><td>IP-based only</td><td>API key, user, or IP-based</td></tr><tr><td><strong>Performance</strong></td><td>High memory usage on large scale</td><td>Optimized with Redis and distributed rate-limiting</td></tr><tr><td><strong>Resilience</strong></td><td>Lost on failure</td><td>Fault-tolerant with Redis</td></tr><tr><td><strong>Configuration</strong></td><td>Static, per instance</td><td>Dynamic, per user/API key/endpoint</td></tr><tr><td><strong>Security</strong></td><td>IP spoofing vulnerable</td><td>More secure with API key/user-level limiting</td></tr><tr><td><strong>Complexity</strong></td><td>Simple to implement</td><td>Requires integration with Redis and Bucket4J</td></tr></tbody></table><hr><h2 id="steps-to-make-the-solution-robust-and-production-ready" tabindex="-1">Steps to Make the Solution Robust and Production-Ready <a class="header-anchor" href="#steps-to-make-the-solution-robust-and-production-ready" aria-label="Permalink to &quot;Steps to Make the Solution Robust and Production-Ready&quot;">​</a></h2><ol><li><strong>Dynamic Rate Limits</strong>: Allow rate limits to be configurable per endpoint, API key, and user level (e.g., tiered limits).</li><li><strong>Logging and Monitoring</strong>: Integrate comprehensive logging of rate limit hits and misses for analysis.</li><li><strong>Error Handling</strong>: Return appropriate error responses (e.g., <code>429 Too Many Requests</code>) with retry headers.</li><li><strong>Graceful Throttling</strong>: Implement throttling before completely denying requests to give clients a chance to slow down.</li><li><strong>API Key Support</strong>: Add support for API key-based rate limiting.</li><li><strong>User-Based Limiting</strong>: Implement rate limiting based on user IDs for better granularity.</li><li><strong>Rate-Limiting Policies</strong>: Provide different rate-limiting policies for different APIs (e.g., higher limits for critical APIs).</li><li><strong>Security</strong>: Protect rate-limiting configurations and ensure secure storage of API keys.</li><li><strong>Rate Limit Burst Window</strong>: Allow bursty traffic by configuring refill rates and bucket sizes to manage spikes effectively.</li><li><strong>Retry Headers</strong>: Include <code>Retry-After</code> headers to inform clients when they can retry.</li><li><strong>Global Rate Limit</strong>: Implement a global rate limit across all endpoints to prevent overall system overload.</li><li><strong>Metrics Export</strong>: Export rate-limiting metrics to monitoring tools like Prometheus or Grafana.</li><li><strong>Client-Based Exemptions</strong>: Allow certain clients or services to bypass rate limits based on API key or role (e.g., internal services).</li><li><strong>Rate-Limiting Analytics</strong>: Provide insights into how many requests are being rate-limited or throttled.</li><li><strong>Token Bucket Adaptation</strong>: Dynamically adjust bucket sizes and refill rates based on real-time system load.</li></ol><hr><h2 id="checklist-for-effective-rate-limiting-and-throttling-implementation" tabindex="-1">Checklist for Effective Rate Limiting and Throttling Implementation <a class="header-anchor" href="#checklist-for-effective-rate-limiting-and-throttling-implementation" aria-label="Permalink to &quot;Checklist for Effective Rate Limiting and Throttling Implementation&quot;">​</a></h2><h3 id="starter" tabindex="-1"><strong>Starter</strong>: <a class="header-anchor" href="#starter" aria-label="Permalink to &quot;**Starter**:&quot;">​</a></h3><ol><li>Implement naive in-memory rate limiting.</li><li>Rate limit based on client IP.</li><li>Return appropriate HTTP status codes (e.g., 429).</li><li>Basic retry mechanism using headers (e.g., <code>Retry-After</code>).</li></ol><h3 id="intermediate" tabindex="-1"><strong>Intermediate</strong>: <a class="header-anchor" href="#intermediate" aria-label="Permalink to &quot;**Intermediate**:&quot;">​</a></h3><ol><li>Integrate Bucket4J for more efficient token bucket rate limiting.</li><li>Use Redis for distributed rate-limiting state.</li><li>Add API key and user-based rate limiting.</li><li>Implement throttling and return <code>Retry-After</code> headers.</li><li>Set up monitoring for rate limit violations.</li><li>Configure rate limits dynamically through <code>application.yml</code>.</li></ol><h3 id="advanced" tabindex="-1"><strong>Advanced</strong>: <a class="header-anchor" href="#advanced" aria-label="Permalink to &quot;**Advanced**:&quot;">​</a></h3><ol><li>Introduce dynamic rate limit configurations based on API, user, or service level.</li><li>Provide monitoring and analytics for rate-limiting behavior using tools like Prometheus or Grafana.</li><li>Implement multi-tiered rate limiting for different user levels (e.g., free vs. premium).</li><li>Enable global rate limits across services.</li><li>Automate and adjust rate-limiting parameters based on traffic patterns.</li><li>Provide rate-limiting exemptions for internal APIs or privileged users.</li><li>Build a self-service configuration UI for API consumers to see rate limits and usage.</li></ol><h2 id="additional-advanced-points-to-consider" tabindex="-1">Additional Advanced Points to Consider <a class="header-anchor" href="#additional-advanced-points-to-consider" aria-label="Permalink to &quot;Additional Advanced Points to Consider&quot;">​</a></h2><ol><li><strong>Dynamic Token Adjustment</strong>: Create algorithms to dynamically adjust token limits based on real-time traffic.</li><li><strong>Hybrid Limiting</strong>: Combine API key and user-based rate limits with global rate limits.</li><li><strong>Quotas</strong>: Implement request quotas that reset daily, weekly, or monthly.</li><li><strong>AI-based Throttling</strong>: Use machine learning to predict traffic bursts and automatically adjust limits.</li><li><strong>Geo-based Rate Limiting</strong>: Implement rate limiting based on geographic location to prevent region-specific attacks.</li></ol><p>This comprehensive guide offers a detailed framework for building a scalable, flexible, and robust rate-limiting solution.</p></div></div></main><footer class="VPDocFooter" data-v-e6f2a212 data-v-1bcd8184><!--[--><!--]--><!----><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"caching-and-filtering.md\":\"ooa27kBh\",\"etags.md\":\"CCFmfai3\",\"hateoas.md\":\"giwmozzi\",\"idempotency.md\":\"BRaHAfDY\",\"index.md\":\"B0-50B3z\",\"kubernetes-setup.md\":\"DWJcB9Vt\",\"neovim.md\":\"CjfnjNQI\",\"rate-limiting-and-throttling.md\":\"C1EVT8kM\",\"readme.md\":\"D9K6DsMW\",\"ssh-server-access.md\":\"DJFRmKqk\",\"team.md\":\"BbNw5voc\",\"temporal-with-springboot.md\":\"Dgmi5ty7\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"VitePress\",\"description\":\"A VitePress site\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>