import{_ as t,c as s,a0 as i,o as a}from"./chunks/framework.BGo0cstt.js";const u=JSON.parse('{"title":"Idempotency in API Design","description":"","frontmatter":{},"headers":[],"relativePath":"idempotency.md","filePath":"idempotency.md"}'),n={name:"idempotency.md"};function o(r,e,l,p,d,h){return a(),s("div",null,e[0]||(e[0]=[i(`<h1 id="idempotency-in-api-design" tabindex="-1">Idempotency in API Design <a class="header-anchor" href="#idempotency-in-api-design" aria-label="Permalink to &quot;Idempotency in API Design&quot;">​</a></h1><h2 id="what-is-idempotency" tabindex="-1">What is Idempotency? <a class="header-anchor" href="#what-is-idempotency" aria-label="Permalink to &quot;What is Idempotency?&quot;">​</a></h2><p>Idempotency is the property of certain operations in which performing the same operation multiple times results in the same outcome. In the context of API design, <strong>idempotency</strong> ensures that repeated requests with the same parameters produce the same result, without unintended side effects such as duplicate charges, repeated record creation, or unnecessary operations.</p><p>For example, if a payment request is sent multiple times due to a network retry, the backend should handle the request idempotently and ensure the payment is only processed once.</p><h2 id="why-idempotency-matters" tabindex="-1">Why Idempotency Matters? <a class="header-anchor" href="#why-idempotency-matters" aria-label="Permalink to &quot;Why Idempotency Matters?&quot;">​</a></h2><p>Idempotency is critical in scenarios where network instability or client retries may occur. Without idempotency, a client might inadvertently submit multiple requests, leading to undesirable results like duplicate payments, multiple user account creations, or erroneous data updates.</p><h3 id="key-benefits" tabindex="-1">Key Benefits: <a class="header-anchor" href="#key-benefits" aria-label="Permalink to &quot;Key Benefits:&quot;">​</a></h3><ul><li><strong>Reliability</strong>: Guarantees that repeated operations don&#39;t cause unwanted changes or duplicate actions.</li><li><strong>User Experience</strong>: Ensures users don&#39;t face double charges or unexpected results when resubmitting forms or retrying failed operations.</li><li><strong>Data Integrity</strong>: Helps in maintaining consistent and clean data, preventing multiple writes for the same operation.</li></ul><h2 id="real-life-use-case-idempotency-in-payment-processing" tabindex="-1">Real-Life Use Case: Idempotency in Payment Processing <a class="header-anchor" href="#real-life-use-case-idempotency-in-payment-processing" aria-label="Permalink to &quot;Real-Life Use Case: Idempotency in Payment Processing&quot;">​</a></h2><p>Consider an e-commerce scenario where a customer submits a payment request. Due to network instability, the request might be sent multiple times. Without idempotency, the server may process multiple payments for the same order, resulting in the customer being charged multiple times.</p><h3 id="example-scenarios-where-idempotency-is-critical" tabindex="-1">Example Scenarios Where Idempotency is Critical: <a class="header-anchor" href="#example-scenarios-where-idempotency-is-critical" aria-label="Permalink to &quot;Example Scenarios Where Idempotency is Critical:&quot;">​</a></h3><ul><li><strong>Payment Gateways</strong>: Preventing duplicate transactions when a payment is retried due to failures or timeouts.</li><li><strong>API Resource Creation</strong>: Ensuring that creating resources (e.g., user accounts) does not lead to duplicates.</li><li><strong>Message Processing</strong>: In systems like Kafka or RabbitMQ, idempotency ensures that the same message is not processed more than once.</li></ul><h2 id="idempotent-and-non-idempotent-methods" tabindex="-1">Idempotent and Non-Idempotent Methods <a class="header-anchor" href="#idempotent-and-non-idempotent-methods" aria-label="Permalink to &quot;Idempotent and Non-Idempotent Methods&quot;">​</a></h2><ul><li><p><strong>Idempotent Methods</strong>: Methods such as <code>GET</code>, <code>PUT</code>, and <code>DELETE</code> are typically idempotent. Performing the same <code>GET</code> request multiple times will return the same result. Similarly, sending a <code>DELETE</code> request multiple times for the same resource should result in the resource being deleted (or no resource found after the first deletion).</p></li><li><p><strong>Non-Idempotent Methods</strong>: Methods like <code>POST</code> are generally not idempotent. If you submit a form multiple times, it might create multiple resources. However, you can implement idempotency for <code>POST</code> requests by using techniques like unique identifiers or idempotency keys.</p></li></ul><h2 id="techniques-for-ensuring-idempotency" tabindex="-1">Techniques for Ensuring Idempotency <a class="header-anchor" href="#techniques-for-ensuring-idempotency" aria-label="Permalink to &quot;Techniques for Ensuring Idempotency&quot;">​</a></h2><ol><li><p><strong>Idempotency Keys</strong>:</p><ul><li>One of the most common methods to ensure idempotency is to include an <strong>idempotency key</strong> in requests. This key uniquely identifies the request and is stored on the server. If the same key is received again, the server can return the cached result instead of processing the request again.</li></ul></li><li><p><strong>Token-Based Idempotency</strong>:</p><ul><li>Some systems use unique tokens, session identifiers, or client-generated UUIDs to ensure that multiple identical requests produce the same result.</li></ul></li><li><p><strong>Conditional Writes</strong>:</p><ul><li>APIs can include conditional headers like <code>If-Match</code> or <code>If-None-Match</code> to determine if the resource was updated since the last request.</li></ul></li></ol><h2 id="real-world-example-idempotency-in-payment-processing" tabindex="-1">Real-World Example: Idempotency in Payment Processing <a class="header-anchor" href="#real-world-example-idempotency-in-payment-processing" aria-label="Permalink to &quot;Real-World Example: Idempotency in Payment Processing&quot;">​</a></h2><h3 id="current-implementation" tabindex="-1">Current Implementation: <a class="header-anchor" href="#current-implementation" aria-label="Permalink to &quot;Current Implementation:&quot;">​</a></h3><p>In this repository, the <strong>PaymentController</strong> ensures idempotency using Redis and idempotency keys. When a payment request is submitted:</p><ol><li><strong>Idempotency Key Handling</strong>: The client sends an idempotency key with the request.</li><li><strong>State Machine for Payment Status</strong>: We implemented a state machine for <code>PENDING</code>, <code>PROCESSING</code>, and <code>COMPLETED</code> states.</li><li><strong>Redis Caching</strong>: The state and transaction results are stored in Redis for quick lookups, preventing duplicate processing.</li></ol><h3 id="decision-matrix-on-why-this-approach-works" tabindex="-1">Decision Matrix on Why This Approach Works: <a class="header-anchor" href="#decision-matrix-on-why-this-approach-works" aria-label="Permalink to &quot;Decision Matrix on Why This Approach Works:&quot;">​</a></h3><table tabindex="0"><thead><tr><th><strong>Factor</strong></th><th><strong>Current Approach</strong></th><th><strong>Why It’s the Best</strong></th></tr></thead><tbody><tr><td>Handling Duplicate Requests</td><td>Idempotency keys stored in Redis</td><td>Prevents duplicate payments from being processed.</td></tr><tr><td>Quick State Lookup</td><td>Redis caching of payment state (<code>PENDING</code>, <code>COMPLETED</code>)</td><td>Low-latency state checks ensure fast responses to repeated requests.</td></tr><tr><td>Robustness</td><td>Locking mechanism to prevent race conditions</td><td>Ensures only one process handles a payment at a time, improving system stability.</td></tr><tr><td>Scalability</td><td>Statelessness with Redis-backed storage</td><td>Supports high traffic and scales horizontally across distributed systems.</td></tr></tbody></table><h3 id="example-flow" tabindex="-1">Example Flow: <a class="header-anchor" href="#example-flow" aria-label="Permalink to &quot;Example Flow:&quot;">​</a></h3><ol><li><strong>First Request</strong>: A payment is submitted, and the server processes it, marking the status as <code>COMPLETED</code> in Redis.</li><li><strong>Subsequent Requests with the Same Key</strong>: Instead of reprocessing the payment, the server returns the cached <code>COMPLETED</code> response.</li></ol><h2 id="best-practices-for-implementing-idempotency" tabindex="-1">Best Practices for Implementing Idempotency <a class="header-anchor" href="#best-practices-for-implementing-idempotency" aria-label="Permalink to &quot;Best Practices for Implementing Idempotency&quot;">​</a></h2><ol><li><p><strong>Generate Idempotency Keys at the Client</strong>: Ensure that the client generates a unique idempotency key for each request.</p></li><li><p><strong>Set Expiration Time for Idempotency Keys</strong>: To avoid stale data, use expiration times for keys stored in Redis.</p></li><li><p><strong>Use Locks to Avoid Race Conditions</strong>: Ensure that only one process is handling a given idempotency key at a time by implementing locking mechanisms.</p></li><li><p><strong>Return Consistent Results</strong>: Always return the same result for the same idempotency key, even if the request is retried multiple times.</p></li><li><p><strong>Monitor for Idempotency Failures</strong>: Implement logging and monitoring to track idempotency failures or exceptions for debugging.</p></li></ol><h2 id="api-endpoints" tabindex="-1">API Endpoints <a class="header-anchor" href="#api-endpoints" aria-label="Permalink to &quot;API Endpoints&quot;">​</a></h2><h3 id="_1-generate-idempotency-key" tabindex="-1">1. Generate Idempotency Key <a class="header-anchor" href="#_1-generate-idempotency-key" aria-label="Permalink to &quot;1\\. Generate Idempotency Key&quot;">​</a></h3><ul><li><p><strong>Endpoint</strong>: /api/server-generated/generate-key</p></li><li><p><strong>Method</strong>: GET</p></li><li><p><strong>Description</strong>: Generates a unique idempotency key for the client to use in subsequent payment requests.</p></li></ul><h3 id="_2-process-payment" tabindex="-1">2. Process Payment <a class="header-anchor" href="#_2-process-payment" aria-label="Permalink to &quot;2\\. Process Payment&quot;">​</a></h3><ul><li><p><strong>Endpoint</strong>: /api/payment</p></li><li><p><strong>Method</strong>: POST</p></li><li><p><strong>Headers</strong>:</p><ul><li>Idempotency-Key: The key generated from the /generate-key endpoint.</li></ul></li><li><p><strong>Body</strong>: JSON object containing payment details (e.g., amount, currency).</p></li><li><p><strong>Description</strong>: Processes a payment using the provided idempotency key and payment details.</p></li></ul><h3 id="_3-get-payment-status" tabindex="-1">3. Get Payment Status <a class="header-anchor" href="#_3-get-payment-status" aria-label="Permalink to &quot;3\\. Get Payment Status&quot;">​</a></h3><ul><li><p><strong>Endpoint</strong>: /api/payment-status</p></li><li><p><strong>Method</strong>: GET</p></li><li><p><strong>Headers</strong>:</p><ul><li>Idempotency-Key: The idempotency key used during payment processing.</li></ul></li><li><p><strong>Description</strong>: Retrieves the status of a payment associated with the given idempotency key.</p></li></ul><h2 id="flow-description" tabindex="-1">Flow Description <a class="header-anchor" href="#flow-description" aria-label="Permalink to &quot;Flow Description&quot;">​</a></h2><h3 id="_1-generating-an-idempotency-key" tabindex="-1">1. Generating an Idempotency Key <a class="header-anchor" href="#_1-generating-an-idempotency-key" aria-label="Permalink to &quot;1\\. Generating an Idempotency Key&quot;">​</a></h3><ul><li><p><strong>Client Action</strong>: Sends a GET request to /api/server-generated/generate-key.</p></li><li><p><strong>Server Action</strong>:</p><ul><li><p>Generates a UUID idempotency key.</p></li><li><p>Stores the key in Redis with an initial value &quot;KEY GENERATED&quot; and an expiration time.</p></li><li><p>Returns the idempotency key to the client.</p></li></ul></li></ul><h3 id="_2-processing-a-payment" tabindex="-1">2. Processing a Payment <a class="header-anchor" href="#_2-processing-a-payment" aria-label="Permalink to &quot;2\\. Processing a Payment&quot;">​</a></h3><ul><li><p><strong>Client Action</strong>: Sends a POST request to /api/payment with the idempotency key and payment details.</p></li><li><p><strong>Server Action</strong>:</p><ul><li><p>Validates the presence of the idempotency key.</p></li><li><p>Acquires a lock for the idempotency key to prevent concurrent processing.</p></li><li><p>Checks if the key exists in Redis:</p><ul><li><p>If the key doesn&#39;t exist, throws an InvalidIdempotencyKeyException.</p></li><li><p>If the key&#39;s value is not &quot;KEY GENERATED&quot;, returns the cached transaction result.</p></li></ul></li><li><p>Processes the payment (simulated).</p></li><li><p>Updates the key&#39;s value in Redis with the transaction ID.</p></li><li><p>Releases the lock.</p></li><li><p>Returns a success response with the transaction ID.</p></li></ul></li></ul><h3 id="_3-retrieving-payment-status" tabindex="-1">3. Retrieving Payment Status <a class="header-anchor" href="#_3-retrieving-payment-status" aria-label="Permalink to &quot;3\\. Retrieving Payment Status&quot;">​</a></h3><ul><li><p><strong>Client Action</strong>: Sends a GET request to /api/payment-status with the idempotency key.</p></li><li><p><strong>Server Action</strong>:</p><ul><li><p>Retrieves the payment status from Redis using the idempotency key.</p></li><li><p>If the key doesn&#39;t exist or payment is not completed, throws a PaymentNotFoundException.</p></li><li><p>Returns the payment status.</p></li></ul></li></ul><h2 id="happy-paths" tabindex="-1">Happy Paths <a class="header-anchor" href="#happy-paths" aria-label="Permalink to &quot;Happy Paths&quot;">​</a></h2><h3 id="scenario-a-successful-payment-processing" tabindex="-1">Scenario A: Successful Payment Processing <a class="header-anchor" href="#scenario-a-successful-payment-processing" aria-label="Permalink to &quot;Scenario A: Successful Payment Processing&quot;">​</a></h3><ol><li></li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>curl -X GET http://localhost:8080/api/server-generated/generate-key**Response**:jsonCopy code&quot;9337393d-b8f5-4ec6-9b61-f9a24333daf3&quot;</span></span></code></pre></div><ol start="2"><li></li></ol><div class="language-angular2html vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">angular2html</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>curl -X POST http://localhost:8080/api/payment \\\\ -H &quot;Idempotency-Key: 9337393d-b8f5-4ec6-9b61-f9a24333daf3&quot; \\\\ -H &quot;Content-Type: application/json&quot; \\\\ -d &#39;{&quot;amount&quot;: &quot;100&quot;, &quot;currency&quot;: &quot;USD&quot;}&#39;**Response**:jsonCopy code&quot;Payment processed successfully with Transaction ID: TXN1693856405000&quot;</span></span></code></pre></div><ol start="3"><li></li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>curl -X GET http://localhost:8080/api/payment-status \\\\ -H &quot;Idempotency-Key: 9337393d-b8f5-4ec6-9b61-f9a24333daf3&quot;**Response**:jsonCopy code&quot;Transaction ID: TXN1693856405000&quot;</span></span></code></pre></div><h3 id="scenario-b-duplicate-payment-request-with-same-idempotency-key" tabindex="-1">Scenario B: Duplicate Payment Request with Same Idempotency Key <a class="header-anchor" href="#scenario-b-duplicate-payment-request-with-same-idempotency-key" aria-label="Permalink to &quot;Scenario B: Duplicate Payment Request with Same Idempotency Key&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>curl -X POST http://localhost:8080/api/payment \\\\ -H &quot;Idempotency-Key: 9337393d-b8f5-4ec6-9b61-f9a24333daf3&quot; \\\\ -H &quot;Content-Type: application/json&quot; \\\\ -d &#39;{&quot;amount&quot;: &quot;100&quot;, &quot;currency&quot;: &quot;USD&quot;}&#39;**Response**:jsonCopy code&quot;Transaction ID: TXN1693856405000&quot;</span></span></code></pre></div><pre><code>*   **Explanation**: The server returns the cached transaction result without reprocessing the payment.
</code></pre><h2 id="unhappy-paths-error-scenarios" tabindex="-1">Unhappy Paths (Error Scenarios) <a class="header-anchor" href="#unhappy-paths-error-scenarios" aria-label="Permalink to &quot;Unhappy Paths (Error Scenarios)&quot;">​</a></h2><h3 id="error-1-missing-idempotency-key" tabindex="-1">Error 1: Missing Idempotency Key <a class="header-anchor" href="#error-1-missing-idempotency-key" aria-label="Permalink to &quot;Error 1: Missing Idempotency Key&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>curl -X POST http://localhost:8080/api/payment \\\\ -H &quot;Content-Type: application/json&quot; \\\\ -d &#39;{&quot;amount&quot;: &quot;100&quot;, &quot;currency&quot;: &quot;USD&quot;}&#39;</span></span></code></pre></div><ul><li><p><strong>Exception Thrown</strong>: MissingIdempotencyKeyException</p></li><li><p><strong>HTTP Status</strong>: 400 Bad Request</p></li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{ &quot;status&quot;: 400, &quot;error&quot;: &quot;Bad Request&quot;, &quot;message&quot;: &quot;Missing Idempotency-Key header.&quot;}</span></span></code></pre></div><h3 id="error-2-invalid-or-non-existent-idempotency-key" tabindex="-1">Error 2: Invalid or Non-Existent Idempotency Key <a class="header-anchor" href="#error-2-invalid-or-non-existent-idempotency-key" aria-label="Permalink to &quot;Error 2: Invalid or Non-Existent Idempotency Key&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>curl -X POST http://localhost:8080/api/payment \\\\ -H &quot;Idempotency-Key: invalid-key&quot; \\\\ -H &quot;Content-Type: application/json&quot; \\\\ -d &#39;{&quot;amount&quot;: &quot;100&quot;, &quot;currency&quot;: &quot;USD&quot;}&#39;</span></span></code></pre></div><ul><li><p><strong>Exception Thrown</strong>: InvalidIdempotencyKeyException</p></li><li><p><strong>HTTP Status</strong>: 400 Bad Request</p></li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{ &quot;status&quot;: 400, &quot;error&quot;: &quot;Bad Request&quot;, &quot;message&quot;: &quot;Invalid or missing Idempotency-Key.&quot;}</span></span></code></pre></div><h3 id="error-3-payment-already-in-progress" tabindex="-1">Error 3: Payment Already in Progress <a class="header-anchor" href="#error-3-payment-already-in-progress" aria-label="Permalink to &quot;Error 3: Payment Already in Progress&quot;">​</a></h3><ul><li><strong>Action</strong>: Two concurrent requests are made with the same idempotency key.</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>curl -X POST http://localhost:8080/api/payment \\\\ -H &quot;Idempotency-Key: 9337393d-b8f5-4ec6-9b61-f9a24333daf3&quot; \\\\ -H &quot;Content-Type: application/json&quot; \\\\ -d &#39;{&quot;amount&quot;: &quot;100&quot;, &quot;currency&quot;: &quot;USD&quot;}&#39;</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>curl -X POST http://localhost:8080/api/payment \\\\ -H &quot;Idempotency-Key: 9337393d-b8f5-4ec6-9b61-f9a24333daf3&quot; \\\\ -H &quot;Content-Type: application/json&quot; \\\\ -d &#39;{&quot;amount&quot;: &quot;100&quot;, &quot;currency&quot;: &quot;USD&quot;}&#39;</span></span></code></pre></div><ul><li><p><strong>Exception Thrown</strong>: PaymentInProgressException (for the second request)</p></li><li><p><strong>HTTP Status</strong>: 409 Conflict</p></li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{ &quot;status&quot;: 409, &quot;error&quot;: &quot;Conflict&quot;, &quot;message&quot;: &quot;Payment is already being processed.&quot;}</span></span></code></pre></div><h3 id="error-4-no-payment-found-for-idempotency-key" tabindex="-1">Error 4: No Payment Found for Idempotency Key <a class="header-anchor" href="#error-4-no-payment-found-for-idempotency-key" aria-label="Permalink to &quot;Error 4: No Payment Found for Idempotency Key&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span> curl -X GET http://localhost:8080/api/payment-status \\\\ -H &quot;Idempotency-Key: invalid-key&quot;</span></span></code></pre></div><ul><li><p><strong>Exception Thrown</strong>: PaymentNotFoundException</p></li><li><p><strong>HTTP Status</strong>: 404 Not Found</p></li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>{ &quot;status&quot;: 404, &quot;error&quot;: &quot;Not Found&quot;, &quot;message&quot;: &quot;No payment found for this Idempotency-Key.&quot;}</span></span></code></pre></div><h2 id="exceptions-thrown" tabindex="-1">Exceptions Thrown <a class="header-anchor" href="#exceptions-thrown" aria-label="Permalink to &quot;Exceptions Thrown&quot;">​</a></h2><ul><li><p><strong>MissingIdempotencyKeyException</strong></p><ul><li><p><strong>When Thrown</strong>: The Idempotency-Key header is missing or empty in the request.</p></li><li><p><strong>HTTP Status</strong>: 400 Bad Request</p></li></ul></li><li><p><strong>InvalidIdempotencyKeyException</strong></p><ul><li><p><strong>When Thrown</strong>: The provided idempotency key does not exist in Redis or was not generated by the server.</p></li><li><p><strong>HTTP Status</strong>: 400 Bad Request</p></li></ul></li><li><p><strong>PaymentInProgressException</strong></p><ul><li><p><strong>When Thrown</strong>: A lock on the idempotency key is already acquired, indicating that the payment is currently being processed.</p></li><li><p><strong>HTTP Status</strong>: 409 Conflict</p></li></ul></li><li><p><strong>PaymentNotFoundException</strong></p><ul><li><p><strong>When Thrown</strong>: No payment associated with the idempotency key is found, or the payment is not yet completed.</p></li><li><p><strong>HTTP Status</strong>: 404 Not Found</p></li></ul></li></ul><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to &quot;Conclusion&quot;">​</a></h2><p>By implementing idempotency using server-generated keys, Redis caching, and proper exception handling, we ensure that:</p><ul><li><p><strong>Duplicate Requests</strong>: Are handled gracefully by returning cached results, preventing duplicate payments.</p></li><li><p><strong>Error Scenarios</strong>: Provide clear and descriptive responses, allowing clients to understand and rectify issues.</p></li><li><p><strong>Concurrency</strong>: Race conditions are avoided using a locking mechanism, ensuring only one process handles a payment at a time.</p></li></ul><p>This approach enhances the reliability and robustness of the payment processing API, providing a better user experience and maintaining data integrity.</p><h2 id="conclusion-1" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion-1" aria-label="Permalink to &quot;Conclusion&quot;">​</a></h2><p>Idempotency is essential for building reliable and fault-tolerant APIs, especially in systems where network issues, retries, or user errors may occur. By leveraging techniques like idempotency keys and state management, you can ensure that repeated requests do not result in unintended side effects or duplicate actions. The approach implemented in this repository, combining Redis with a state machine for payment processing, is an efficient and scalable solution for ensuring idempotency.</p><h3 id="final-segment-for-readme-how-to-run-this-program" tabindex="-1">Final Segment for README: How to Run This Program <a class="header-anchor" href="#final-segment-for-readme-how-to-run-this-program" aria-label="Permalink to &quot;Final Segment for README: How to Run This Program&quot;">​</a></h3><p>This section outlines the steps required to run the Spring Boot application and how to set up a Redis instance using Docker.</p><hr><h3 id="_1-prerequisites" tabindex="-1"><strong>1. Prerequisites</strong> <a class="header-anchor" href="#_1-prerequisites" aria-label="Permalink to &quot;**1. Prerequisites**&quot;">​</a></h3><p>Before running the program, make sure you have the following installed on your system:</p><ul><li><strong>Java 11 or higher</strong>: To build and run the Spring Boot application.</li><li><strong>Maven</strong>: To build the Spring Boot project.</li><li><strong>Docker</strong>: To spin up the Redis instance locally.</li><li><strong>Git</strong>: To clone the repository.</li></ul><h3 id="_2-clone-the-repository" tabindex="-1"><strong>2. Clone the Repository</strong> <a class="header-anchor" href="#_2-clone-the-repository" aria-label="Permalink to &quot;**2. Clone the Repository**&quot;">​</a></h3><p>First, clone the project repository to your local machine:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/sardul3/io-api-best-practices-boot.git</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> io-api-best-practices-boot</span></span></code></pre></div><h3 id="_3-run-redis-using-docker" tabindex="-1"><strong>3. Run Redis Using Docker</strong> <a class="header-anchor" href="#_3-run-redis-using-docker" aria-label="Permalink to &quot;**3. Run Redis Using Docker**&quot;">​</a></h3><p>We will use Docker to spin up a Redis instance. If Docker is installed, run the following command to start a Redis container:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> redis-cache</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 6379:6379</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> redis:latest</span></span></code></pre></div><ul><li><p>This command pulls the latest Redis image, starts the container, and exposes Redis on port <code>6379</code>, which is the default Redis port.</p></li><li><p>To verify that Redis is running, use the following command:</p></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ps</span></span></code></pre></div><ul><li>You should see a running Redis container in the output. To check Redis logs, run:</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> logs</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> redis-cache</span></span></code></pre></div><h3 id="_4-update-the-application-yml-if-required" tabindex="-1"><strong>4. Update the <code>application.yml</code> (If Required)</strong> <a class="header-anchor" href="#_4-update-the-application-yml-if-required" aria-label="Permalink to &quot;**4. Update the \`application.yml\` (If Required)**&quot;">​</a></h3><p>The Redis configuration in the Spring Boot application is located in <code>src/main/resources/application.yml</code>. By default, the app is configured to connect to Redis running on <code>localhost</code> at port <code>6379</code>. If you are using a custom Redis configuration, make sure to update the connection properties in the <code>application.yml</code> file:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">spring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  redis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">localhost</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6379</span></span></code></pre></div><h3 id="_5-build-and-run-the-application" tabindex="-1"><strong>5. Build and Run the Application</strong> <a class="header-anchor" href="#_5-build-and-run-the-application" aria-label="Permalink to &quot;**5. Build and Run the Application**&quot;">​</a></h3><p>Now that Redis is running, you can build and run the Spring Boot application.</p><h4 id="build-the-application" tabindex="-1">Build the application: <a class="header-anchor" href="#build-the-application" aria-label="Permalink to &quot;Build the application:&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mvn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clean</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span></code></pre></div><h4 id="run-the-application" tabindex="-1">Run the application: <a class="header-anchor" href="#run-the-application" aria-label="Permalink to &quot;Run the application:&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mvn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> spring-boot:run</span></span></code></pre></div><p>This will start the Spring Boot application, which will connect to the Redis instance running in Docker.</p><h3 id="_6-access-the-endpoints" tabindex="-1"><strong>6. Access the Endpoints</strong> <a class="header-anchor" href="#_6-access-the-endpoints" aria-label="Permalink to &quot;**6. Access the Endpoints**&quot;">​</a></h3><p>Once the application is running, you can access the following endpoints:</p><ol><li><p><strong>Generate Idempotency Key</strong>:<br> This endpoint generates a server-side idempotency key that can be used in subsequent API requests.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:8080/api/server-generated/generate-key</span></span></code></pre></div></li><li><p><strong>Process Payment</strong>:<br> Use the generated idempotency key to process a payment.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> POST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:8080/api/payment</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Idempotency-Key: YOUR_GENERATED_KEY&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Content-Type: application/json&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{&quot;amount&quot;: &quot;100&quot;, &quot;currency&quot;: &quot;USD&quot;}&#39;</span></span></code></pre></div></li><li><p><strong>Get Payment Status</strong>:<br> Retrieve the payment status using the same idempotency key.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:8080/api/payment-status</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Idempotency-Key: YOUR_GENERATED_KEY&quot;</span></span></code></pre></div></li><li><p><strong>Check Redis Health</strong>:<br> Check if the application is successfully connected to Redis.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:8080/api/health/redis</span></span></code></pre></div></li><li><p><strong>Get Value for Key</strong>:<br> Retrieve the value for a specific Redis key.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:8080/api/health/redis/key/YOUR_KEY</span></span></code></pre></div></li><li><p><strong>Get Redis Stats</strong>:<br> Get the Redis server statistics, such as memory usage, total keys, and more.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GET</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:8080/api/health/redis/stats</span></span></code></pre></div></li></ol><h3 id="_7-stop-the-redis-container" tabindex="-1"><strong>7. Stop the Redis Container</strong> <a class="header-anchor" href="#_7-stop-the-redis-container" aria-label="Permalink to &quot;**7. Stop the Redis Container**&quot;">​</a></h3><p>Once you are done testing, you can stop and remove the Redis container by running the following commands:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> redis-cache</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> redis-cache</span></span></code></pre></div><p>This will stop the Redis instance and remove the container.</p>`,111)]))}const g=t(n,[["render",o]]);export{u as __pageData,g as default};
