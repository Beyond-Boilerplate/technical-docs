import{_ as i,c as a,a0 as n,o as t}from"./chunks/framework.BGo0cstt.js";const E=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"temporal-with-springboot.md","filePath":"temporal-with-springboot.md"}'),e={name:"temporal-with-springboot.md"};function l(h,s,p,r,k,o){return t(),a("div",null,s[0]||(s[0]=[n(`<p>Here’s a <strong>checklist</strong> of <strong>DOs and DON&#39;Ts</strong> when working with Temporal in a Spring Boot application, specifically focusing on code practices to follow:</p><h2 id="dos" tabindex="-1"><strong>DOs</strong> <a class="header-anchor" href="#dos" aria-label="Permalink to &quot;**DOs**&quot;">​</a></h2><h4 id="_1-do-use-temporal-s-workflow-time-api" tabindex="-1">1. <strong>DO Use Temporal&#39;s Workflow Time API</strong> <a class="header-anchor" href="#_1-do-use-temporal-s-workflow-time-api" aria-label="Permalink to &quot;1. **DO Use Temporal&#39;s Workflow Time API**&quot;">​</a></h4><ul><li><strong>Use <code>Workflow.currentTimeMillis()</code> or <code>Workflow.currentDateTime()</code></strong> instead of <code>System.currentTimeMillis()</code> or <code>LocalDateTime.now()</code>. This ensures deterministic behavior in workflows.</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">long</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentTimeMillis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><h4 id="_2-do-keep-workflow-code-deterministic" tabindex="-1">2. <strong>DO Keep Workflow Code Deterministic</strong> <a class="header-anchor" href="#_2-do-keep-workflow-code-deterministic" aria-label="Permalink to &quot;2. **DO Keep Workflow Code Deterministic**&quot;">​</a></h4><ul><li>Ensure that the code inside workflows is deterministic (i.e., it should produce the same results on re-execution).</li><li><strong>Avoid non-deterministic operations like</strong>: <ul><li>Current system time (<code>System.currentTimeMillis()</code>).</li><li>Random numbers (<code>Math.random()</code>).</li><li>System calls, file I/O, and database calls inside workflows.</li></ul></li></ul><h4 id="_3-do-encapsulate-non-deterministic-code-in-activities" tabindex="-1">3. <strong>DO Encapsulate Non-Deterministic Code in Activities</strong> <a class="header-anchor" href="#_3-do-encapsulate-non-deterministic-code-in-activities" aria-label="Permalink to &quot;3. **DO Encapsulate Non-Deterministic Code in Activities**&quot;">​</a></h4><ul><li>Put any non-deterministic code, such as HTTP requests, database calls, or system-dependent actions (e.g., reading files), inside activities rather than workflows.</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ActivityMethod</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetchFromAPI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String url);</span></span></code></pre></div><h4 id="_4-do-define-activities-and-workflows-as-interfaces" tabindex="-1">4. <strong>DO Define Activities and Workflows as Interfaces</strong> <a class="header-anchor" href="#_4-do-define-activities-and-workflows-as-interfaces" aria-label="Permalink to &quot;4. **DO Define Activities and Workflows as Interfaces**&quot;">​</a></h4><ul><li>Always define workflows and activities as <strong>interfaces</strong> and provide their implementation separately.</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyWorkflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WorkflowMethod</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyActivities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ActivityMethod</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetchData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_5-do-use-retry-policies" tabindex="-1">5. <strong>DO Use Retry Policies</strong> <a class="header-anchor" href="#_5-do-use-retry-policies" aria-label="Permalink to &quot;5. **DO Use Retry Policies**&quot;">​</a></h4><ul><li>Define retry policies for activities to handle failures gracefully. Use Temporal’s built-in retry mechanism for activities.</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RetryOptions retryOptions </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RetryOptions.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setInitialInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Duration.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ofSeconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setMaximumAttempts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ActivityOptions options </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ActivityOptions.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setRetryOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(retryOptions)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><h4 id="_6-do-use-spring-beans-in-activities" tabindex="-1">6. <strong>DO Use Spring Beans in Activities</strong> <a class="header-anchor" href="#_6-do-use-spring-beans-in-activities" aria-label="Permalink to &quot;6. **DO Use Spring Beans in Activities**&quot;">​</a></h4><ul><li>Since activities are normal Java classes, they can take advantage of Spring Boot features like dependency injection.</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyActivitiesImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyActivities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MyService myService;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetchData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">input</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> myService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_7-do-handle-workflow-versioning" tabindex="-1">7. <strong>DO Handle Workflow Versioning</strong> <a class="header-anchor" href="#_7-do-handle-workflow-versioning" aria-label="Permalink to &quot;7. **DO Handle Workflow Versioning**&quot;">​</a></h4><ul><li>Use versioning when making backward-incompatible changes to workflows to ensure that workflows already in progress continue functioning.</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> version </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;myChange&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Workflow.DEFAULT_VERSION, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (version </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Workflow.DEFAULT_VERSION) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Old behavior</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // New behavior</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_8-do-use-signals-and-queries-for-communication" tabindex="-1">8. <strong>DO Use Signals and Queries for Communication</strong> <a class="header-anchor" href="#_8-do-use-signals-and-queries-for-communication" aria-label="Permalink to &quot;8. **DO Use Signals and Queries for Communication**&quot;">​</a></h4><ul><li><strong>Signals</strong> can be used to send external input into running workflows asynchronously.</li><li><strong>Queries</strong> can be used to fetch the current state of a workflow without modifying its execution.</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SignalMethod</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> notifyOfEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String eventName);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">QueryMethod</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCurrentStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><h4 id="_9-do-use-workflow-futures-and-promises-for-async-operations" tabindex="-1">9. <strong>DO Use Workflow Futures and Promises for Async Operations</strong> <a class="header-anchor" href="#_9-do-use-workflow-futures-and-promises-for-async-operations" aria-label="Permalink to &quot;9. **DO Use Workflow Futures and Promises for Async Operations**&quot;">​</a></h4><ul><li>Temporal supports asynchronous operations within workflows using <strong>Futures</strong> and <strong>Promises</strong>. Utilize these for parallel execution of activities.</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Promise&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; future </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Async.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(myActivities</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fetchData, input);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">String result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> future.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><h4 id="_10-do-use-workflow-newactivitystub-to-create-activity-stubs" tabindex="-1">10. <strong>DO Use <code>Workflow.newActivityStub()</code> to Create Activity Stubs</strong> <a class="header-anchor" href="#_10-do-use-workflow-newactivitystub-to-create-activity-stubs" aria-label="Permalink to &quot;10. **DO Use \`Workflow.newActivityStub()\` to Create Activity Stubs**&quot;">​</a></h4><ul><li>Always use <code>Workflow.newActivityStub()</code> to create activity stubs inside workflows. This ensures Temporal can track and manage the activity’s lifecycle.</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MyActivities activities </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newActivityStub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(MyActivities.class, options);</span></span></code></pre></div><h4 id="_11-do-leverage-spring-boot-configuration-for-temporal-settings" tabindex="-1">11. <strong>DO Leverage Spring Boot Configuration for Temporal Settings</strong> <a class="header-anchor" href="#_11-do-leverage-spring-boot-configuration-for-temporal-settings" aria-label="Permalink to &quot;11. **DO Leverage Spring Boot Configuration for Temporal Settings**&quot;">​</a></h4><ul><li>Use Spring Boot configuration to manage properties such as Temporal service URLs, namespaces, and worker configurations through <code>application.properties</code> or <code>application.yml</code>.</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">temporal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  namespace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;default&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  service-url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;localhost:7233&quot;</span></span></code></pre></div><hr><h2 id="don-ts" tabindex="-1"><strong>DON&#39;Ts</strong> <a class="header-anchor" href="#don-ts" aria-label="Permalink to &quot;**DON&#39;Ts**&quot;">​</a></h2><h4 id="_1-don-t-use-non-deterministic-apis-in-workflows" tabindex="-1">1. <strong>DON’T Use Non-Deterministic APIs in Workflows</strong> <a class="header-anchor" href="#_1-don-t-use-non-deterministic-apis-in-workflows" aria-label="Permalink to &quot;1. **DON’T Use Non-Deterministic APIs in Workflows**&quot;">​</a></h4><ul><li>Avoid using APIs like <code>System.currentTimeMillis()</code>, <code>Math.random()</code>, <code>Thread.sleep()</code>, or any form of system interaction in workflow code.</li><li>These will break Temporal’s replay mechanism and lead to unexpected behavior.</li></ul><h4 id="_2-don-t-perform-blocking-calls-in-workflows" tabindex="-1">2. <strong>DON’T Perform Blocking Calls in Workflows</strong> <a class="header-anchor" href="#_2-don-t-perform-blocking-calls-in-workflows" aria-label="Permalink to &quot;2. **DON’T Perform Blocking Calls in Workflows**&quot;">​</a></h4><ul><li>Never use blocking calls like <code>Thread.sleep()</code> or I/O operations in workflows. Use Temporal’s built-in timers instead.</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Duration.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ofMinutes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span></code></pre></div><h4 id="_3-don-t-call-activities-directly-in-the-workflow-implementation" tabindex="-1">3. <strong>DON’T Call Activities Directly in the Workflow Implementation</strong> <a class="header-anchor" href="#_3-don-t-call-activities-directly-in-the-workflow-implementation" aria-label="Permalink to &quot;3. **DON’T Call Activities Directly in the Workflow Implementation**&quot;">​</a></h4><ul><li>Never directly call activity implementations inside workflows. Always invoke activities via their stubs. This allows Temporal to handle retries, failures, and task distribution.</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Incorrect</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MyActivitiesImpl activities </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyActivitiesImpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">activities.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fetchData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Correct</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MyActivities activities </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newActivityStub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(MyActivities.class, options);</span></span></code></pre></div><h4 id="_4-don-t-modify-global-variables-or-states-in-workflows" tabindex="-1">4. <strong>DON’T Modify Global Variables or States in Workflows</strong> <a class="header-anchor" href="#_4-don-t-modify-global-variables-or-states-in-workflows" aria-label="Permalink to &quot;4. **DON’T Modify Global Variables or States in Workflows**&quot;">​</a></h4><ul><li>Avoid modifying global or shared states within workflows, as this can introduce non-deterministic behavior.</li></ul><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Avoid modifying global/static variables</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> counter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WorkflowMethod</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    counter</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// This introduces non-determinism</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="_5-don-t-use-external-libraries-that-depend-on-system-time-or-threading" tabindex="-1">5. <strong>DON’T Use External Libraries that Depend on System Time or Threading</strong> <a class="header-anchor" href="#_5-don-t-use-external-libraries-that-depend-on-system-time-or-threading" aria-label="Permalink to &quot;5. **DON’T Use External Libraries that Depend on System Time or Threading**&quot;">​</a></h4><ul><li>Avoid using libraries that rely on system time, multi-threading, or other non-deterministic operations. These can break the deterministic nature of workflows.</li></ul><h4 id="_6-don-t-assume-activity-and-workflow-code-will-run-on-the-same-machine" tabindex="-1">6. <strong>DON’T Assume Activity and Workflow Code Will Run on the Same Machine</strong> <a class="header-anchor" href="#_6-don-t-assume-activity-and-workflow-code-will-run-on-the-same-machine" aria-label="Permalink to &quot;6. **DON’T Assume Activity and Workflow Code Will Run on the Same Machine**&quot;">​</a></h4><ul><li>Temporal workflows and activities may run on different machines. Avoid any direct resource sharing or assuming a shared environment between them.</li></ul><h4 id="_7-don-t-use-exception-handling-to-control-workflow-flow" tabindex="-1">7. <strong>DON’T Use Exception Handling to Control Workflow Flow</strong> <a class="header-anchor" href="#_7-don-t-use-exception-handling-to-control-workflow-flow" aria-label="Permalink to &quot;7. **DON’T Use Exception Handling to Control Workflow Flow**&quot;">​</a></h4><ul><li>Avoid using exceptions for normal workflow logic flow control. Use Temporal’s retry and failure mechanisms instead to handle errors properly.</li></ul><h4 id="_8-don-t-overuse-workflow-sleep" tabindex="-1">8. <strong>DON’T Overuse Workflow Sleep</strong> <a class="header-anchor" href="#_8-don-t-overuse-workflow-sleep" aria-label="Permalink to &quot;8. **DON’T Overuse Workflow Sleep**&quot;">​</a></h4><ul><li>Avoid excessive use of <code>Workflow.sleep()</code> for polling or waiting. Instead, consider using activities for waiting on external conditions or events, or leverage <strong>signals</strong>.</li></ul><h4 id="_9-don-t-hardcode-workflow-and-activity-configurations" tabindex="-1">9. <strong>DON’T Hardcode Workflow and Activity Configurations</strong> <a class="header-anchor" href="#_9-don-t-hardcode-workflow-and-activity-configurations" aria-label="Permalink to &quot;9. **DON’T Hardcode Workflow and Activity Configurations**&quot;">​</a></h4><ul><li>Avoid hardcoding activity timeout or retry policies in the workflow. Use Spring configuration files or pass them through constructors to make your workflows flexible.</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">temporal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  activities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    default-retry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      initial-interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1s</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      max-attempts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span></span></code></pre></div><h4 id="_10-don-t-forget-to-test-workflows-and-activities-separately" tabindex="-1">10. <strong>DON’T Forget to Test Workflows and Activities Separately</strong> <a class="header-anchor" href="#_10-don-t-forget-to-test-workflows-and-activities-separately" aria-label="Permalink to &quot;10. **DON’T Forget to Test Workflows and Activities Separately**&quot;">​</a></h4><ul><li>Always test workflows and activities in isolation. Temporal provides testing frameworks like <code>TestWorkflowEnvironment</code> that let you simulate workflow execution without depending on the actual Temporal service.</li></ul><hr><h2 id="conclusion" tabindex="-1"><strong>Conclusion:</strong> <a class="header-anchor" href="#conclusion" aria-label="Permalink to &quot;**Conclusion:**&quot;">​</a></h2><p>Following these <strong>DOs and DON&#39;Ts</strong> ensures that your Temporal workflows and activities remain deterministic, scalable, and maintainable within a <strong>Spring Boot</strong> environment. By leveraging Temporal’s features and best practices, you can build highly reliable distributed systems that are easier to manage and debug.</p><h2 id="durable-execution-with-temporal-replay" tabindex="-1">Durable Execution with Temporal Replay <a class="header-anchor" href="#durable-execution-with-temporal-replay" aria-label="Permalink to &quot;Durable Execution with Temporal Replay&quot;">​</a></h2><p><strong>Step-by-Step Workflow Execution</strong></p><ul><li>The workflow execution begins by combining code from the workflow definition with an input request (e.g., customer details and pizza order).</li><li>Temporal logs events such as workflow execution started, workflow tasks scheduled, and activity tasks scheduled.</li></ul><p><strong>Worker and Cluster Interaction</strong></p><ul><li>A worker accepts tasks from the queue, and it pulls these tasks to execute step-by-step code.</li><li>Commands such as requesting activity execution are issued by the worker to the Temporal cluster.</li></ul><p><strong>Handling Workflow Crashes and Recovery via Replay</strong></p><ul><li>The video simulates a worker crash during workflow execution and explains how Temporal handles state recovery through replay.</li><li>Temporal uses event history to restore the workflow&#39;s previous state, ensuring that it matches the pre-crash execution.</li></ul><p><strong>Replay Mechanism and Determinism</strong></p><ul><li>Temporal&#39;s workflow replay mechanism relies on event history to restore variable states, meaning the workflow can resume execution as if the crash never occurred.</li><li>Temporal ensures workflows are deterministic by suppressing duplicated log outputs during replay, eliminating any discrepancies.</li></ul><p><strong>Conclusion</strong></p><ul><li>The replay mechanism guarantees that workflows maintain the same state before and after a crash.</li><li>Temporal logs the final &quot;workflow execution completed&quot; event, ensuring durable execution.</li></ul><h2 id="understanding-temporal-workflow-determinism" tabindex="-1">Understanding Temporal Workflow Determinism <a class="header-anchor" href="#understanding-temporal-workflow-determinism" aria-label="Permalink to &quot;Understanding Temporal Workflow Determinism&quot;">​</a></h2><p><strong>Introduction to Workflow Determinism</strong></p><ul><li>what it means for Temporal workflow code to be deterministic and why this is crucial for Temporal&#39;s operations?</li><li>Temporal requires that workflows behave deterministically, meaning they should produce the same output given the same input every time.</li></ul><p><strong>Temporal Workflow Execution</strong></p><ul><li>As the worker executes workflow code, it issues commands to the Temporal cluster to perform actions like executing activities or starting timers.</li><li>Temporal keeps an event history for each workflow execution, where specific commands (e.g., scheduling a task or starting a timer) correspond to events in the history.</li></ul><p><strong>History Replay and Determinism</strong></p><ul><li>History replay allows Temporal to recover the state of a workflow after a worker crash or other interruptions.</li><li>During replay, workers check if commands match the corresponding events in the history. If a mismatch occurs, a non-deterministic error is triggered, making it impossible to restore the workflow state.</li></ul><p><strong>Example of Non-Deterministic Workflow</strong></p><ul><li>Consider a non-deterministic error with a workflow that uses a random number generator.</li><li>In one execution, the random number generates &quot;84,&quot; leading to the next line being executed. However, during replay, the random number generates &quot;14,&quot; causing a different path to be taken.</li><li>This mismatch in the sequence of commands results in a non-deterministic error, as the worker cannot align the commands with the event history.</li></ul><h2 id="importance-of-determinism" tabindex="-1">Importance of Determinism <a class="header-anchor" href="#importance-of-determinism" aria-label="Permalink to &quot;Importance of Determinism&quot;">​</a></h2><ul><li>For Temporal to guarantee durable workflow execution, the workflow must always produce the same sequence of commands for a given input.</li><li>Non-determinism, such as using random values, can disrupt this process and cause errors during workflow recovery.</li></ul><p><strong>Examples of Changes That May Lead to Non-Deterministic Errors</strong></p><ul><li>Adding or removing an Activity</li><li>Switching the Activity Type used in a call to an Activity Method</li><li>Adding or removing a Timer</li><li>Altering the execution order of Activities or Timers relative to one another</li></ul><p><strong>Examples of Changes That Do Not Lead to Non-Deterministic Errors</strong></p><ul><li>Modifying statements in a Workflow Definition, such as logging statements, that do not affect the Commands generated during Workflow Execution</li><li>Changing attributes in a ActivityOptions or RetryPolicy</li><li>Modifying code inside of an Activity Definition</li></ul><h2 id="overview-of-temporal" tabindex="-1">Overview of Temporal <a class="header-anchor" href="#overview-of-temporal" aria-label="Permalink to &quot;Overview of Temporal&quot;">​</a></h2><ul><li><strong>Temporal</strong>: Open-source durable execution system for scalable and reliable applications.</li><li><strong>Key Features</strong>: Supports recovery from crashes, state reconstruction using History Replay, and deterministic Workflow execution.</li></ul><h2 id="temporal-applications" tabindex="-1">Temporal Applications <a class="header-anchor" href="#temporal-applications" aria-label="Permalink to &quot;Temporal Applications&quot;">​</a></h2><ul><li><strong>Workflow and Activity Definitions</strong>: Code representing business logic, while SDK components manage Workers and Clients.</li><li><strong>Automatic Recovery</strong>: Temporal automatically reconstructs state after failures using History Replay.</li></ul><h2 id="best-practices-for-temporal-development" tabindex="-1">Best Practices for Temporal Development <a class="header-anchor" href="#best-practices-for-temporal-development" aria-label="Permalink to &quot;Best Practices for Temporal Development&quot;">​</a></h2><ol><li>Use a single class for input/output parameters in Workflows and Activities for backward compatibility.</li><li>Avoid large data for inputs/outputs due to Temporal event size limits.</li><li>Ensure deterministic Workflow code (e.g., use <code>Workflow.sleep</code> instead of <code>Thread.sleep</code>).</li><li>Activities can fail and be retried; Workflows should fail less often.</li><li>Use Temporal&#39;s logging API to avoid duplicate logs during History Replay.</li></ol><h2 id="testing-temporal-applications" tabindex="-1">Testing Temporal Applications <a class="header-anchor" href="#testing-temporal-applications" aria-label="Permalink to &quot;Testing Temporal Applications&quot;">​</a></h2><ul><li><strong>Automated Testing</strong>: Use <code>io.temporal.testing</code> for unit tests, JUnit, Mockito, and time-skipping for Workflow tests.</li><li><strong>Replaying Previous Executions</strong>: Test compatibility of Workflow modifications by replaying past executions.</li></ul><h2 id="workflow-execution" tabindex="-1">Workflow Execution <a class="header-anchor" href="#workflow-execution" aria-label="Permalink to &quot;Workflow Execution&quot;">​</a></h2><ul><li><strong>Unique Workflow ID</strong>: Ensure unique Workflow IDs across all Workflow Executions in the same namespace.</li><li><strong>Open and Closed States</strong>: Workflow starts in an open state and can close as Completed, Failed, Canceled, Terminated, etc.</li><li><strong>Sticky Execution</strong>: Optimizes execution by favoring the same Worker for multiple tasks.</li><li><strong>Continue-As-New</strong>: Used to split Workflow Execution to keep Event History manageable.</li></ul><h2 id="event-history" tabindex="-1">Event History <a class="header-anchor" href="#event-history" aria-label="Permalink to &quot;Event History&quot;">​</a></h2><ul><li>Logs all Workflow events with timestamps and attributes, up to a 50K event limit.</li><li><strong>Retention Period</strong>: Workflow history is retained post-execution for a set period.</li></ul><h2 id="building-and-running-temporal-applications" tabindex="-1">Building and Running Temporal Applications <a class="header-anchor" href="#building-and-running-temporal-applications" aria-label="Permalink to &quot;Building and Running Temporal Applications&quot;">​</a></h2><ul><li><strong>No Specific Tools</strong>: Applications can be built and deployed using tools like Maven, CI/CD pipelines, and Docker/Kubernetes.</li><li><strong>Production Setup</strong>: Deploy multiple instances for scalability and availability.</li></ul><h2 id="temporal-cluster-components" tabindex="-1">Temporal Cluster Components <a class="header-anchor" href="#temporal-cluster-components" aria-label="Permalink to &quot;Temporal Cluster Components&quot;">​</a></h2><ul><li><strong>Temporal Cluster</strong>: Consists of services like History, Matching, and Worker Services, using gRPC for communication.</li><li><strong>Temporal Cloud</strong>: Managed service alternative to self-hosting.</li></ul><h2 id="deploying-to-production" tabindex="-1">Deploying to Production <a class="header-anchor" href="#deploying-to-production" aria-label="Permalink to &quot;Deploying to Production&quot;">​</a></h2><ul><li><strong>Frontend Service</strong>: Clients connect via TCP (default port 7233).</li><li><strong>Safe Activity Changes</strong>: Activities can be modified freely, but Workflow changes require compatibility testing.</li></ul><h2 id="signals-in-temporal" tabindex="-1">Signals in Temporal <a class="header-anchor" href="#signals-in-temporal" aria-label="Permalink to &quot;Signals in Temporal&quot;">​</a></h2><ul><li><strong>Signals</strong>: Asynchronous messages used to change the state or control the flow of a running Workflow Execution.</li><li><strong>Usage</strong>: Suitable for workflows that need to react to external events, such as human task completions or user interactions.</li><li><strong>Examples</strong>: <ul><li>Modifying orders in e-commerce.</li><li>Confirming payment to proceed with shipping.</li><li>Handling frequently changing data like stock prices.</li></ul></li></ul><h2 id="dynamicsignalhandler" tabindex="-1">DynamicSignalHandler <a class="header-anchor" href="#dynamicsignalhandler" aria-label="Permalink to &quot;DynamicSignalHandler&quot;">​</a></h2><ul><li><strong>Purpose</strong>: Handles unregistered or unexpected Signals in a workflow.</li><li><strong>Usage</strong>: Register a handler for undefined Signals using <code>Workflow.registerListener()</code>.</li></ul><h2 id="when-to-throw-exceptions-in-temporal-workflows" tabindex="-1">When to Throw Exceptions in Temporal Workflows <a class="header-anchor" href="#when-to-throw-exceptions-in-temporal-workflows" aria-label="Permalink to &quot;When to Throw Exceptions in Temporal Workflows&quot;">​</a></h2><ul><li><strong>Throw Exceptions</strong>: <ul><li>For non-recoverable errors (e.g., invalid inputs).</li><li>Explicit workflow cancellation (e.g., user cancellation).</li><li>Fatal system failures.</li><li>Exceeding retries or timeouts.</li></ul></li><li><strong>Do Not Throw Exceptions</strong>: <ul><li>For transient errors (Temporal handles retries).</li><li>For expected conditions (use conditional logic).</li><li>During graceful cancellations (use signals, not exceptions).</li></ul></li></ul><h2 id="signal-with-start" tabindex="-1">Signal-With-Start <a class="header-anchor" href="#signal-with-start" aria-label="Permalink to &quot;Signal-With-Start&quot;">​</a></h2><ul><li><strong>Feature</strong>: Sends a signal to a Workflow and starts it if it is not running.</li><li><strong>Usage</strong>: Useful to ensure workflow execution when signaling.</li></ul><h2 id="common-signal-issues" tabindex="-1">Common Signal Issues <a class="header-anchor" href="#common-signal-issues" aria-label="Permalink to &quot;Common Signal Issues&quot;">​</a></h2><ul><li><strong>Outgoing Signal Limit</strong>: 2000 pending outgoing Signals per Workflow.</li><li><strong>Receiving Signal Limit</strong>: 10,000 Signals per Workflow; 51,200 event history limit.</li><li><strong>Handling High Signal Volume</strong>: Use batching to avoid UnhandledCommand errors or performance degradation.</li></ul><h2 id="summary-of-cancellation-scopes-in-temporal-java-sdk" tabindex="-1">Summary of Cancellation Scopes in Temporal Java SDK <a class="header-anchor" href="#summary-of-cancellation-scopes-in-temporal-java-sdk" aria-label="Permalink to &quot;Summary of Cancellation Scopes in Temporal Java SDK&quot;">​</a></h2><p>A <strong>Cancellation Scope</strong> in the Temporal Java SDK allows workflows to handle cancellation requests in a controlled manner. Each part of a workflow can be run inside its own cancellation scope, which can be canceled independently of other parts. Cancellation scopes help manage cleanup, timeouts, and resource management when a workflow or its activities are canceled.</p><p>Here are the main pointers and examples:</p><h3 id="_1-basic-cancellation-scope" tabindex="-1">1. <strong>Basic Cancellation Scope</strong> <a class="header-anchor" href="#_1-basic-cancellation-scope" aria-label="Permalink to &quot;1. **Basic Cancellation Scope**&quot;">​</a></h3><ul><li><strong>Purpose:</strong> Cancels all child operations when the scope is canceled.</li><li><strong>Usage:</strong> Useful when you want to run a set of tasks that may need to be canceled if a condition arises.</li></ul><p><strong>Example:</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CancellationScope scope </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newCancellationScope</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Run multiple asynchronous activities</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (String greeting </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> greetings) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            results.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Async.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(activities</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">composeGreeting, greeting, name));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">scope.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Non-blocking execution within the scope</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">String result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Promise.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">anyOf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(results).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">scope.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Cancel all uncompleted tasks</span></span></code></pre></div><h3 id="_2-cancellation-scope-with-timeout" tabindex="-1">2. <strong>Cancellation Scope with Timeout</strong> <a class="header-anchor" href="#_2-cancellation-scope-with-timeout" aria-label="Permalink to &quot;2. **Cancellation Scope with Timeout**&quot;">​</a></h3><ul><li><strong>Purpose:</strong> Automatically cancels operations within the scope if they take too long.</li><li><strong>Usage:</strong> Suitable for scenarios where tasks should have a time limit.</li></ul><p><strong>Example:</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CancellationScope scope </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newCancellationScope</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> activities.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">updateInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ActivityFailure </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newTimer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Duration.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ofSeconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">thenApply</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        scope.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Cancel if timeout occurs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    scope.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Run the activity</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ActivityFailure </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCause</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CanceledFailure) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Activity canceled due to timeout.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_3-detached-cancellation-scope" tabindex="-1">3. <strong>Detached Cancellation Scope</strong> <a class="header-anchor" href="#_3-detached-cancellation-scope" aria-label="Permalink to &quot;3. **Detached Cancellation Scope**&quot;">​</a></h3><ul><li><strong>Purpose:</strong> Performs cleanup after workflow cancellation without being canceled itself.</li><li><strong>Usage:</strong> Suitable for tasks like cleanup that need to complete even if the workflow is canceled.</li></ul><p><strong>Example:</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.greeting </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> activities.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sayHello</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> greeting;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ActivityFailure </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">af</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Detached scope for cleanup after workflow cancellation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CancellationScope detached </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newDetachedCancellationScope</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> greeting </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> activities.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sayGoodBye</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    detached.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> af;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_4-external-cancellation" tabindex="-1">4. <strong>External Cancellation</strong> <a class="header-anchor" href="#_4-external-cancellation" aria-label="Permalink to &quot;4. **External Cancellation**&quot;">​</a></h3><ul><li><strong>Purpose:</strong> Allows an external source (e.g., user action) to trigger the cancellation of a workflow.</li><li><strong>Usage:</strong> Used when the workflow needs to be interrupted and properly cleaned up.</li></ul><p><strong>Example:</strong></p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">orderProcessingWorkflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String name) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Workflow implementation</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ActivityFailure </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">af</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (af.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCause</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CanceledFailure) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            CancellationScope detached </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newDetachedCancellationScope</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                this</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cleanup); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Perform necessary cleanup</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            detached.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> af;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_5-best-practices" tabindex="-1">5. <strong>Best Practices</strong> <a class="header-anchor" href="#_5-best-practices" aria-label="Permalink to &quot;5. **Best Practices**&quot;">​</a></h3><ul><li>Use <strong>DetachedCancellationScopes</strong> for critical operations that must run to completion.</li><li>Handle external cancellation requests by catching <code>CanceledFailure</code> and performing necessary cleanup.</li><li>Always rethrow <code>CanceledFailure</code> in activities to ensure Temporal correctly recognizes the cancellation.</li></ul><p>By understanding and applying these patterns, you can handle workflow and activity cancellations gracefully in Temporal, ensuring efficient resource management and clean shutdowns.</p><h2 id="asynchronous-activity-completion-in-temporal" tabindex="-1">Asynchronous Activity Completion in Temporal <a class="header-anchor" href="#asynchronous-activity-completion-in-temporal" aria-label="Permalink to &quot;Asynchronous Activity Completion in Temporal&quot;">​</a></h2><p>Asynchronous Activity Completion in Temporal allows an Activity to return without marking it as complete, enabling external systems to interact with Temporal before the activity is considered finished. This is particularly useful when an Activity involves long-running tasks or external dependencies, such as waiting for user input or handling operations on an external system.</p><h4 id="key-concepts" tabindex="-1">Key Concepts: <a class="header-anchor" href="#key-concepts" aria-label="Permalink to &quot;Key Concepts:&quot;">​</a></h4><ol><li><p><strong>Asynchronous Activity Completion</strong>: The Activity does not complete immediately after the method returns. Instead, it can stay &quot;in progress&quot; while awaiting an external trigger to mark it complete.</p></li><li><p><strong>Task Tokens</strong>: These are unique identifiers used to track an Activity execution. They can be passed to external systems to allow completion later.</p></li><li><p><strong>Heartbeats</strong>: While an Activity is in progress, periodic updates or &quot;heartbeats&quot; can be sent back to the Temporal server to keep the Activity alive and prevent it from timing out.</p></li><li><p><strong>Activity Execution Context</strong>: The <code>ActivityExecutionContext</code> provides methods to control the lifecycle of the Activity, such as marking it as incomplete and sending heartbeats.</p></li><li><p><strong>Activity Completion Client</strong>: The <code>ActivityCompletionClient</code> is used to signal the completion of an Activity from an external process, passing the Task Token and the result of the Activity.</p></li></ol><h4 id="example-code-asynchronous-activity-completion" tabindex="-1">Example Code: Asynchronous Activity Completion <a class="header-anchor" href="#example-code-asynchronous-activity-completion" aria-label="Permalink to &quot;Example Code: Asynchronous Activity Completion&quot;">​</a></h4><h5 id="activity-implementation" tabindex="-1">Activity Implementation <a class="header-anchor" href="#activity-implementation" aria-label="Permalink to &quot;Activity Implementation&quot;">​</a></h5><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.activity.Activity;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.activity.ActivityExecutionContext;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VideoProcessingActivityImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VideoProcessingActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uploadVideo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">videoPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ActivityExecutionContext context </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Activity.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Get the Task Token and log it securely (this can be sent to an external system)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] taskToken </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTaskToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doNotCompleteOnReturn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Simulate the upload task being handed over to an external system</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // The actual upload process would occur asynchronously outside of Temporal</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Return immediately but do not complete the activity</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Upload initiated. Task completion will be handled asynchronously.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h5 id="external-completion-service" tabindex="-1">External Completion Service <a class="header-anchor" href="#external-completion-service" aria-label="Permalink to &quot;External Completion Service&quot;">​</a></h5><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.client.ActivityCompletionClient;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.client.WorkflowClient;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.serviceclient.WorkflowServiceStubs;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> java.util.Base64;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ExternalUploadCompletionService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> InterruptedException {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        WorkflowServiceStubs service </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkflowServiceStubs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newLocalServiceStubs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        WorkflowClient client </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkflowClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(service);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ActivityCompletionClient completionClient </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newActivityCompletionClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Simulate external task progress</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] taskToken </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Base64.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDecoder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">decode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(args[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Thread.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Simulating a delay of 3 seconds</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            completionClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">heartbeat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(taskToken, i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;% complete&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Complete the activity with the final result</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        completionClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">complete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(taskToken, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Upload successful. Video URL: https://example.com/video/1234&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="steps-to-complete-an-asynchronous-activity" tabindex="-1">Steps to Complete an Asynchronous Activity: <a class="header-anchor" href="#steps-to-complete-an-asynchronous-activity" aria-label="Permalink to &quot;Steps to Complete an Asynchronous Activity:&quot;">​</a></h2><ol><li><p><strong>Provide Task Token</strong>: The <code>ActivityExecutionContext</code> provides a task token, which is passed to the external service to later mark the activity as complete.</p></li><li><p><strong>doNotCompleteOnReturn()</strong>: The method <code>doNotCompleteOnReturn()</code> ensures that the Activity does not finish even after returning from the method.</p></li><li><p><strong>Heartbeats</strong>: The external system periodically sends heartbeats to Temporal to inform it of ongoing progress, avoiding the Activity being marked as failed due to timeouts.</p></li><li><p><strong>Completion</strong>: Once the external process completes, the <code>ActivityCompletionClient</code> uses the task token to notify Temporal that the Activity is complete.</p></li></ol><h4 id="best-practices" tabindex="-1">Best Practices: <a class="header-anchor" href="#best-practices" aria-label="Permalink to &quot;Best Practices:&quot;">​</a></h4><ul><li><strong>Secure Task Tokens</strong>: Treat task tokens as sensitive information and encrypt them before passing to external services.</li><li><strong>Retry Handling</strong>: Make sure to account for task retries, as each retry creates a new task token.</li><li><strong>Heartbeat Management</strong>: Use heartbeats to track progress and avoid timeouts.</li></ul><hr><h3 id="async-activity-completion-example-with-percentage-updates-every-3-seconds-in-spring-boot" tabindex="-1">Async Activity Completion Example with Percentage Updates (Every 3 Seconds) in Spring Boot <a class="header-anchor" href="#async-activity-completion-example-with-percentage-updates-every-3-seconds-in-spring-boot" aria-label="Permalink to &quot;Async Activity Completion Example with Percentage Updates (Every 3 Seconds) in Spring Boot&quot;">​</a></h3><p>Here&#39;s how to implement an asynchronous activity where progress updates are sent every 3 seconds, with a 10% increment in progress, completing the task at 100%.</p><h5 id="activity-interface" tabindex="-1">Activity Interface <a class="header-anchor" href="#activity-interface" aria-label="Permalink to &quot;Activity Interface&quot;">​</a></h5><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VideoProcessingActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uploadVideo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">videoPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h5 id="activity-implementation-1" tabindex="-1">Activity Implementation <a class="header-anchor" href="#activity-implementation-1" aria-label="Permalink to &quot;Activity Implementation&quot;">​</a></h5><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.activity.Activity;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.activity.ActivityExecutionContext;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.slf4j.Logger;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.slf4j.LoggerFactory;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Service;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VideoProcessingActivityImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> VideoProcessingActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Logger logger </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LoggerFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(VideoProcessingActivityImpl.class);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uploadVideo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">videoPath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ActivityExecutionContext context </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Activity.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Retrieve task token</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] taskToken </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTaskToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Task Token for async completion: {}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Base64.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getEncoder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encodeToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(taskToken));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Mark activity as &quot;in-progress&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doNotCompleteOnReturn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Simulate handing over the task to another service (asynchronously)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processUpload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(taskToken)).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Video upload started&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processUpload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">taskToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // Simulate upload progress (10% every 3 seconds)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                Thread.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Wait for 3 seconds</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                sendHeartbeat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(taskToken, i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;% uploaded&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            completeActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(taskToken, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Upload complete. URL: https://example.com/video/1234&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (InterruptedException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Upload process interrupted&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sendHeartbeat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">taskToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">progress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Send heartbeat to Temporal to avoid timeout</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        Activity.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">heartbeat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(progress);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Heartbeat sent: {}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, progress);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> completeActivity</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">taskToken</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Use completion client to mark the activity as complete</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        WorkflowServiceStubs service </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkflowServiceStubs.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newLocalServiceStubs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        WorkflowClient client </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkflowClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(service);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ActivityCompletionClient completionClient </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newActivityCompletionClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        completionClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">complete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(taskToken, result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Activity completed with result: {}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, result);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>This implementation leverages:</p><ul><li><strong>Heartbeats every 3 seconds</strong>: Progress is sent as heartbeats at regular intervals (10% increments).</li><li><strong>Task Completion</strong>: After 10 heartbeats (i.e., 100%), the external system completes the activity.</li></ul><h3 id="key-points-summary-temporal-workflows-with-java" tabindex="-1">Key Points Summary: Temporal Workflows with Java <a class="header-anchor" href="#key-points-summary-temporal-workflows-with-java" aria-label="Permalink to &quot;Key Points Summary: Temporal Workflows with Java&quot;">​</a></h3><ol><li><p><strong>Signaling &amp; Querying Workflows</strong>:</p><ul><li>Signals can be sent from a client to a Workflow or from one Workflow to another using <code>newExternalWorkflowStub()</code>.</li><li>A Workflow can receive up to 10,000 signals, after which batching signals can help prevent overload.</li><li>Handling asynchronous signal actions: Queue signals instead of processing immediately.</li><li>Queries can be sent by getting a handle on a Workflow.</li></ul></li><li><p><strong>Search Attributes</strong>:</p><ul><li><strong>List Filter</strong>: Acts like a SQL-like query to find open Workflow Executions.</li><li><strong>Search Attributes</strong>: Default attributes are created automatically, while custom attributes can be set in client code or via Workflow logic.</li></ul></li><li><p><strong>Workflow Execution Cancellations</strong>:</p><ul><li><strong>Heartbeats</strong>: Periodic pings sent to indicate progress and Worker health.</li><li><strong>Heartbeat Timeout</strong>: If a timeout occurs due to missed heartbeats, the activity can resume using the last heartbeat data.</li><li><strong>Workflow Cancellations</strong>: Cancellations terminate Workflow gracefully, catching exceptions with <code>CancelledFailure</code> for cleanup.</li><li><strong>Non-Cancellable Scopes</strong>: Protect critical operations by defining non-cancellable parts of the Workflow.</li></ul></li><li><p><strong>Asynchronous Activity Completion</strong>:</p><ul><li>Allows the Activity method to return without marking the Activity as complete.</li><li>Useful for long-running, unpredictable, or external system-dependent tasks.</li><li>Task Token is a unique identifier for an Activity Execution across machines.</li></ul></li></ol><p>These points capture the essentials of interacting with workflows, signals, queries, search attributes, and cancellation handling within the Temporal platform, with a focus on Java.</p><h3 id="cancellationscope-in-temporal-with-java-21-and-spring-boot-practical-example" tabindex="-1">CancellationScope in Temporal with Java 21 and Spring Boot: Practical Example <a class="header-anchor" href="#cancellationscope-in-temporal-with-java-21-and-spring-boot-practical-example" aria-label="Permalink to &quot;CancellationScope in Temporal with Java 21 and Spring Boot: Practical Example&quot;">​</a></h3><h4 id="scenario-payment-processing-workflow-with-cleanup-in-case-of-cancellation" tabindex="-1"><strong>Scenario</strong>: Payment Processing Workflow with Cleanup in Case of Cancellation <a class="header-anchor" href="#scenario-payment-processing-workflow-with-cleanup-in-case-of-cancellation" aria-label="Permalink to &quot;**Scenario**: Payment Processing Workflow with Cleanup in Case of Cancellation&quot;">​</a></h4><p>Imagine a payment processing system where the system performs several steps, including charging a customer, updating the order status, and sending a confirmation email. If the user cancels the payment midway through the process, you want to ensure that any reserved resources (e.g., holding inventory or creating an order) are released properly, but the charge should not be applied to the user’s account.</p><p>To achieve this, you can use Temporal&#39;s <strong>CancellationScope</strong> to define how the system responds to cancellation requests while still performing necessary cleanup actions. We’ll integrate this with <strong>Java 21</strong> and <strong>Spring Boot</strong> following best practices.</p><h3 id="steps" tabindex="-1">Steps: <a class="header-anchor" href="#steps" aria-label="Permalink to &quot;Steps:&quot;">​</a></h3><ol><li><strong>Create a Workflow to handle payment processing.</strong></li><li><strong>Introduce a cancellable scope</strong> for the payment charge.</li><li><strong>Handle cleanup operations</strong> (like rolling back transactions or releasing resources) in case of cancellation.</li><li><strong>Use Spring Boot with Temporal SDK</strong> to define the workflow and activities.</li></ol><hr><h3 id="_1-project-setup-spring-boot-and-temporal-sdk" tabindex="-1"><strong>1. Project Setup (Spring Boot and Temporal SDK)</strong> <a class="header-anchor" href="#_1-project-setup-spring-boot-and-temporal-sdk" aria-label="Permalink to &quot;**1. Project Setup (Spring Boot and Temporal SDK)**&quot;">​</a></h3><p>Make sure to include the required dependencies in your <code>build.gradle</code> or <code>pom.xml</code> for Temporal and Spring Boot.</p><h4 id="build-gradle" tabindex="-1"><code>build.gradle</code> <a class="header-anchor" href="#build-gradle" aria-label="Permalink to &quot;\`build.gradle\`&quot;">​</a></h4><div class="language-groovy vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">plugins {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    id </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;org.springframework.boot&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> version </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;3.1.0&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    id </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;io.spring.dependency-management&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> version </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;1.1.0&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    id </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;java&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dependencies {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    implementation </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;org.springframework.boot:spring-boot-starter&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    implementation </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;io.temporal:temporal-sdk:1.14.0&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    implementation </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;io.temporal:spring-boot-starter-temporal:1.0.0&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h3 id="_2-workflow-interface" tabindex="-1"><strong>2. Workflow Interface</strong> <a class="header-anchor" href="#_2-workflow-interface" aria-label="Permalink to &quot;**2. Workflow Interface**&quot;">​</a></h3><p>We’ll define the <code>PaymentWorkflow</code> that will handle the steps for payment processing.</p><h4 id="paymentworkflow-java" tabindex="-1"><code>PaymentWorkflow.java</code> <a class="header-anchor" href="#paymentworkflow-java" aria-label="Permalink to &quot;\`PaymentWorkflow.java\`&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.example.payment.workflow;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.workflow.WorkflowInterface;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.workflow.WorkflowMethod;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WorkflowInterface</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PaymentWorkflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WorkflowMethod</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processPayment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">orderId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">customerId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h3 id="_3-workflow-implementation-with-cancellation-scope" tabindex="-1"><strong>3. Workflow Implementation with Cancellation Scope</strong> <a class="header-anchor" href="#_3-workflow-implementation-with-cancellation-scope" aria-label="Permalink to &quot;**3. Workflow Implementation with Cancellation Scope**&quot;">​</a></h3><p>We&#39;ll use the <code>CancellationScope</code> to wrap the <code>chargeCustomer</code> activity, which can be canceled if requested.</p><h4 id="paymentworkflowimpl-java" tabindex="-1"><code>PaymentWorkflowImpl.java</code> <a class="header-anchor" href="#paymentworkflowimpl-java" aria-label="Permalink to &quot;\`PaymentWorkflowImpl.java\`&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.example.payment.workflow;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.workflow.CancellationScope;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.workflow.Workflow;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.slf4j.Logger;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.slf4j.LoggerFactory;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PaymentWorkflowImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PaymentWorkflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Logger logger </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LoggerFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PaymentWorkflowImpl.class);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymentActivities paymentActivities </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newActivityStub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PaymentActivities.class);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> processPayment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">orderId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">customerId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Starting payment workflow for Order ID: {}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, orderId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // Create a cancellable scope around charging the customer</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            CancellationScope chargeScope </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Workflow.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newCancellationScope</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                paymentActivities.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chargeCustomer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(customerId, amount);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            chargeScope.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Execute the scope (charge the customer)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Customer charged successfully!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // Update the order status after payment succeeds</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            paymentActivities.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">updateOrderStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;PAID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // Send confirmation email to the customer</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            paymentActivities.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sendConfirmationEmail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(customerId, orderId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Exception </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // If any cancellation happens or failure occurs, handle it.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Payment failed or was canceled for Order ID: {}. Performing cleanup.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, orderId);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // Cleanup the order by marking it as canceled</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            paymentActivities.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">updateOrderStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(orderId, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CANCELED&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="key-points-in-code" tabindex="-1">Key Points in Code: <a class="header-anchor" href="#key-points-in-code" aria-label="Permalink to &quot;Key Points in Code:&quot;">​</a></h3><ul><li><strong>CancellationScope</strong>: The <code>CancellationScope</code> is created around the critical step where the customer is charged.</li><li><strong>Graceful Handling</strong>: If the workflow is canceled, it catches the exception and performs cleanup activities (e.g., marking the order as canceled).</li></ul><hr><h3 id="_4-activities-interface" tabindex="-1"><strong>4. Activities Interface</strong> <a class="header-anchor" href="#_4-activities-interface" aria-label="Permalink to &quot;**4. Activities Interface**&quot;">​</a></h3><p>Define the activities involved in the payment processing workflow, such as charging the customer, updating the order status, and sending a confirmation email.</p><h4 id="paymentactivities-java" tabindex="-1"><code>PaymentActivities.java</code> <a class="header-anchor" href="#paymentactivities-java" aria-label="Permalink to &quot;\`PaymentActivities.java\`&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.example.payment.workflow;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.activity.ActivityInterface;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.activity.ActivityMethod;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ActivityInterface</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PaymentActivities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ActivityMethod</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> chargeCustomer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">customerId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ActivityMethod</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateOrderStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">orderId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ActivityMethod</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sendConfirmationEmail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">customerId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">orderId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h3 id="_5-activities-implementation" tabindex="-1"><strong>5. Activities Implementation</strong> <a class="header-anchor" href="#_5-activities-implementation" aria-label="Permalink to &quot;**5. Activities Implementation**&quot;">​</a></h3><p>Implement the activities. The payment charging activity will simulate a delay, and we&#39;ll include logging to track the flow of execution.</p><h4 id="paymentactivitiesimpl-java" tabindex="-1"><code>PaymentActivitiesImpl.java</code> <a class="header-anchor" href="#paymentactivitiesimpl-java" aria-label="Permalink to &quot;\`PaymentActivitiesImpl.java\`&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.example.payment.workflow;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.slf4j.Logger;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.slf4j.LoggerFactory;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Service;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Service</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PaymentActivitiesImpl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PaymentActivities</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Logger logger </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LoggerFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PaymentActivitiesImpl.class);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> chargeCustomer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">customerId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // Simulate a delay in processing the payment</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Charging customer {} an amount of \${}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, customerId, amount);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Thread.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Simulate external processing time</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Customer {} charged successfully.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, customerId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (InterruptedException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Payment process interrupted for customer {}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, customerId);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RuntimeException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Payment interrupted&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateOrderStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">orderId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Updating order {} status to &#39;{}&#39;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, orderId, status);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Simulate order status update in the database</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sendConfirmationEmail</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">customerId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">orderId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Sending confirmation email for Order ID: {} to Customer ID: {}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, orderId, customerId);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Simulate email sending</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h3 id="_6-spring-boot-configuration" tabindex="-1"><strong>6. Spring Boot Configuration</strong> <a class="header-anchor" href="#_6-spring-boot-configuration" aria-label="Permalink to &quot;**6. Spring Boot Configuration**&quot;">​</a></h3><p>Configure Spring Boot to enable Temporal workers and define the worker that executes the <code>PaymentWorkflow</code>.</p><h4 id="temporalconfig-java" tabindex="-1"><code>TemporalConfig.java</code> <a class="header-anchor" href="#temporalconfig-java" aria-label="Permalink to &quot;\`TemporalConfig.java\`&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.example.payment.config;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.example.payment.workflow.PaymentActivitiesImpl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.example.payment.workflow.PaymentWorkflowImpl;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.worker.WorkerFactory;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.worker.WorkerFactoryOptions;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.context.annotation.Bean;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.context.annotation.Configuration;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Configuration</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TemporalConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkerFactory </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">workerFactory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        WorkerFactoryOptions options </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkerFactoryOptions.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkerFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newInstance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TemporalWorkflowClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getService</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), options);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> startWorkers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkerFactory </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">factory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> worker </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> factory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newWorker</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;payment-task-queue&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        worker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">registerWorkflowImplementationTypes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PaymentWorkflowImpl.class);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        worker.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">registerActivitiesImplementations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PaymentActivitiesImpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        factory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h3 id="_7-handling-workflow-cancellation" tabindex="-1"><strong>7. Handling Workflow Cancellation</strong> <a class="header-anchor" href="#_7-handling-workflow-cancellation" aria-label="Permalink to &quot;**7. Handling Workflow Cancellation**&quot;">​</a></h3><p>Finally, we&#39;ll simulate the client-side code to start and cancel the workflow execution.</p><h4 id="paymentclient-java" tabindex="-1"><code>PaymentClient.java</code> <a class="header-anchor" href="#paymentclient-java" aria-label="Permalink to &quot;\`PaymentClient.java\`&quot;">​</a></h4><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.example.payment.client;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> com.example.payment.workflow.PaymentWorkflow;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.client.WorkflowClient;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.client.WorkflowOptions;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.client.WorkflowStub;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> io.temporal.serviceclient.WorkflowServiceStubs;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.slf4j.Logger;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.slf4j.LoggerFactory;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Component</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PaymentClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Logger logger </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LoggerFactory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getLogger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PaymentClient.class);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkflowClient workflowClient;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PaymentClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(WorkflowClient </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">workflowClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.workflowClient </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workflowClient;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> startPaymentWorkflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">orderId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">customerId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">double</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        WorkflowOptions options </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkflowOptions.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setTaskQueue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;payment-task-queue&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        PaymentWorkflow workflow </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> workflowClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">newWorkflowStub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(PaymentWorkflow.class, options);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        WorkflowStub workflowStub </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> WorkflowStub.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fromTyped</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workflow);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // Start the workflow asynchronously</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            WorkflowClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(workflow</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">processPayment, orderId, customerId, amount);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // Simulate a scenario where we cancel the workflow after 3 seconds</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            Thread.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            workflowStub.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Workflow for Order ID: {} canceled successfully&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, orderId);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Exception </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Error starting or canceling the workflow&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h3 id="_8-execution" tabindex="-1"><strong>8. Execution</strong> <a class="header-anchor" href="#_8-execution" aria-label="Permalink to &quot;**8. Execution**&quot;">​</a></h3><ol><li><strong>Start the workflow</strong>: The workflow starts by charging the customer and performing subsequent tasks.</li><li><strong>Cancel the workflow</strong>: The workflow is canceled midway through the payment charge, and cleanup is performed to cancel the order.</li></ol><hr><h2 id="best-practices-applied" tabindex="-1"><strong>Best Practices Applied</strong>: <a class="header-anchor" href="#best-practices-applied" aria-label="Permalink to &quot;**Best Practices Applied**:&quot;">​</a></h2><ul><li><strong>Graceful Cancellation</strong>: By wrapping the critical <code>chargeCustomer</code> operation in a <code>CancellationScope</code>, we can ensure that if the operation is canceled, the workflow handles it gracefully and performs any necessary cleanup.</li><li><strong>Asynchronous Activities</strong>: The activities are kept short and simple, following the best practice of delegating longer operations to external services.</li><li><strong>Spring Boot Integration</strong>: Temporal SDK is seamlessly integrated with Spring Boot, and beans are used to configure the worker and client interactions.</li></ul><p>This example demonstrates how you can implement cancellable workflows using Temporal&#39;s <code>CancellationScope</code> while following best practices for handling workflow cancellation, maintaining Spring Boot structure, and using Java 21 features.</p>`,214)]))}const c=i(e,[["render",l]]);export{E as __pageData,c as default};
